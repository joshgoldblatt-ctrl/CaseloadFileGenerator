<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigate Caseload File Generator v3.6.3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js">
// Category Manager: Apply Year/Term
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'cm-apply'){
    const y = parseInt(document.getElementById('cm-year').value, 10);
    const t = document.getElementById('cm-term').value;
    if (!isNaN(y) && (t==='FA' || t==='SP')){
      TERM_STATE.year = y;
      TERM_STATE.termCode = t;
      // trigger a re-render if function available
      if (typeof window.renderDashboard === 'function') {
        window.renderDashboard(); // full refresh
      } else if (typeof window.refreshCategoryManager === 'function') {
        window.refreshCategoryManager();
      } else {
        // Fallback: force a simple reflow by switching tabs if you have tab controls; otherwise noop.
      }
    }
  }
});

</script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 30px; }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
        }
        .file-input-wrapper { 
            margin-bottom: 15px; 
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .file-input-wrapper:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .upload-icon {
            font-size: 32px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0;
            padding: 8px;
            background-color: #f1f3f5;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { 
            background-color: #0056b3 !important; 
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0,123,255,0.4) !important;
        }
        button:disabled {
            background-color: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: 0 4px 8px rgba(108,117,125,0.3) !important;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        .progress-details {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }
        .file-item {
            padding: 5px 0;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
        }
        .file-item.loaded { 
            color: #28a745; 
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navigate Caseload File Generator</h1>
        <p style="margin-top: -20px; margin-bottom: 30px; color: #666; font-style: italic;">Developed by Josh Goldblatt using Claude</p>
        
        <!-- Required File Section -->
        <div class="upload-section" style="border: 2px solid #007bff; background: linear-gradient(135deg, #f8f9ff 0%, #e7f3ff 100%);">
            <div class="section-header">
                <span class="upload-icon">üìã</span>
                <h2 style="color: #007bff; margin: 0;">Required File</h2>
            </div>
            <div class="file-input-wrapper">
                <label for="mainFile">Main CSV File (Enrollment and Caseload Report): <span style="color: #dc3545; font-weight: bold;">*REQUIRED</span></label>
                <div class="help-text">
                    <strong>Must contain:</strong> Student ID, Assigned Staff, Category columns<br>
                    <strong>Format:</strong> CSV file exported from your enrollment system
                </div>
                <input type="file" id="mainFile" accept=".csv">
                <div class="file-item" id="mainFileStatus" style="margin-top: 10px; padding: 5px 10px; border-radius: 4px; font-size: 14px;"></div>
            </div>
        </div>
        
        <!-- Optional Files Section -->
        <div class="upload-section" style="border: 2px dashed #28a745; background: linear-gradient(135deg, #f8fff9 0%, #eafaf1 100%);">
            <div class="section-header">
                <span class="upload-icon">üìÅ</span>
                <h2 style="color: #28a745; margin: 0;">Optional Lookup Files</h2>
            </div>
            <p style="font-size: 14px; color: #155724; margin-bottom: 20px; padding: 10px; background-color: rgba(40,167,69,0.1); border-radius: 6px;">
                <strong>üí° Tip:</strong> These files enable additional ID columns and department mappings in your output. Upload any that are available to enhance your data.
            </p>
            
            <div class="file-input-wrapper">
                <label for="advisorFile">
                    <span style="font-size: 18px; vertical-align: middle;">üë§</span> Advisor Staff File
                </label>
                <div class="help-text">
                    <strong>Required columns:</strong><br>
                    ‚Ä¢ <code>Staff Organizer Name</code> or <code>Advisor Name</code> or <code>Name</code> - Must match advisor names in main file<br>
                    ‚Ä¢ <code>Staff_ID</code> or <code>Staff ID</code> or <code>ID</code> - Unique identifier for advisor<br>
                    <strong>Format:</strong> Names must exactly match those in the "Professional Advisor" field
                </div>
                <input type="file" id="advisorFile" accept=".csv">
                <div class="file-item" id="advisorFileStatus" style="margin-top: 10px; padding: 5px 10px; border-radius: 4px; font-size: 14px;"></div>
            </div>
            
            <div class="file-input-wrapper">
                <label for="facultyFile">
                    <span style="font-size: 18px; vertical-align: middle;">üë®‚Äçüè´</span> Faculty Mentor List File
                </label>
                <div class="help-text">
                    <strong>Required columns:</strong><br>
                    ‚Ä¢ <code>Faculty Mentor</code> or <code>Faculty Name</code> or <code>Name</code> - Must match mentor names in main file<br>
                    <strong>Optional columns:</strong><br>
                    ‚Ä¢ <code>Staff_ID</code> or <code>Staff ID</code> or <code>ID</code> - Faculty identifier<br>
                    ‚Ä¢ <code>DEPARTMENT</code> or <code>Department</code> or <code>Faculty Department</code> - Faculty's home department<br>
                    ‚Ä¢ <code>DEPARTMENT_SUB</code> or <code>Department Sub</code> - Sub-department classification<br>
                    ‚Ä¢ <code>DEPARTMENT_HOME</code> or <code>Department Home</code> - Home department designation<br>
                    <strong>Format:</strong> Names must exactly match those in the "Faculty Mentor" field
                </div>
                <input type="file" id="facultyFile" accept=".csv">
                <div class="file-item" id="facultyFileStatus" style="margin-top: 10px; padding: 5px 10px; border-radius: 4px; font-size: 14px;"></div>
            </div>
            
            <div class="file-input-wrapper">
                <label for="peerFile">
                    <span style="font-size: 18px; vertical-align: middle;">üë•</span> Peer Advisor List File
                </label>
                <div class="help-text">
                    <strong>Required columns:</strong><br>
                    ‚Ä¢ <code>Staff Organizer Name</code> or <code>Peer Advisor Name</code> or <code>Peer Advisor</code> or <code>Name</code> - Must match peer advisor names<br>
                    ‚Ä¢ <code>Staff ID</code> or <code>Staff_ID</code> or <code>Peer ID</code> or <code>ID</code> - Unique identifier for peer advisor<br>
                    <strong>Optional columns:</strong><br>
                    ‚Ä¢ <code>Department</code> or <code>Academic Department</code> or <code>Peer Department</code> or <code>Peer Advisor Department</code> - Peer's department<br>
                    <strong>Format:</strong> Names must exactly match those in the "Peer Advisor" field
                </div>
                <input type="file" id="peerFile" accept=".csv">
                <div class="file-item" id="peerFileStatus" style="margin-top: 10px; padding: 5px 10px; border-radius: 4px; font-size: 14px;"></div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button id="processBtn" disabled style="background-color: #6c757d; color: white; border: none; padding: 16px 32px; border-radius: 8px; cursor: not-allowed; font-size: 18px; font-weight: bold; box-shadow: 0 4px 8px rgba(108,117,125,0.3); transition: all 0.3s ease;">üöÄ Process Files</button>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-text" id="progressText">Processing files...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-details" id="progressDetails">Initializing...</div>
        </div>
        
        <div id="resultsArea"></div>
    </div>

    <script>
        // CONSTANTS AND CONFIGURATION
        const CONSTANTS = {
            
  ADVISOR_OFFICE_ALIASES: {
    'ECI - College Now Advisor' : 'ECI - College Now',
    'ECI - Energy Tech HS Advisor' : 'ECI - Energy Tech HS',
    'ECI - International HS Advisor' : 'ECI - International HS',
    'ECI - Middle College HS Advisor' : 'ECI - Middle College HS',
    'CUNY Start Advisor' : 'CUNY Start',
    'Math Start Advisor' : 'Math Start'
  },
ROLES: {
                ADVISOR: ['asap advisor', 'college discovery counselor', 'student advising services advisor', 
                         'international student services advisor', 'careers in engineering advisor', 
                         'cuny 2x tech academy advisor', 'veteran services advisor',
      'eci - college now advisor',
      'eci - energy tech hs advisor',
      'eci - international hs advisor',
      'eci - middle college hs advisor',
      'cuny start advisor',
      'math start advisor',],
                FACULTY: ['faculty mentor'],
                CLINICAL: ['clinical health faculty advisor', 'health sciences faculty advisor'],
                PEER: ['peer advisor'],
                PROGRAM_DIRECTOR: ['program director'],
                LIBRARIAN: ['librarian']
            },
            COLUMNS: {
                STUDENT_ID: 'Student ID',
                ASSIGNED_STAFF: 'Assigned Staff',
                CATEGORY: 'Category',
                PROFESSIONAL_ADVISOR: 'Professional Advisor',
                ADVISING_OFFICE: 'Advising Office',
                FACULTY_MENTOR: 'Faculty Mentor',
                PEER_ADVISOR: 'Peer Advisor',
                PROGRAM_DIRECTOR: 'Program Director',
                LIBRARIAN: 'Librarian',
                ACADEMIC_STANDING: 'Academic Standing',
                Major: 'Major',
                NAV_M: 'Navigate Major',
                STUDENT_DEPT: 'Student Academic Department',
                STUDENT_DEPT_SUB: 'Student Academic Department_sub'
            },
            LOOKUP_CONFIGS: {
                advisor: {
                    nameColumns: ['Staff Organizer Name', 'Advisor Name', 'Name'],
                    idColumns: ['Staff_ID', 'Staff ID', 'ID'],
                    outputColumn: 'Staff ID'
                },
                faculty: {
                    nameColumns: ['Faculty Mentor', 'Faculty Name', 'Name'],
                    idColumns: ['Staff_ID', 'Staff ID', 'ID'],
                    deptColumns: ['DEPARTMENT', 'Department', 'Faculty Department'],
                    deptSubColumns: ['DEPARTMENT_SUB', 'Department Sub', 'Department_Sub'],
                    deptHomeColumns: ['DEPARTMENT_HOME', 'Department Home', 'Department_Home'],
                    outputColumns: {
                        id: 'Mentor ID',
                        dept: 'Faculty Academic Department',
                        deptSub: 'Faculty Academic Department_sub',
                        deptHome: 'Faculty Academic Department_home'
                    }
                },
                peer: {
                    nameColumns: ['Staff Organizer Name', 'Peer Advisor Name', 'Peer Advisor', 'Name'],
                    idColumns: ['Staff ID', 'Staff_ID', 'Peer ID', 'ID'],
                    deptColumns: ['Department', 'Academic Department', 'Peer Department', 'Peer Advisor Department'],
                    outputColumns: {
                        id: 'Peer ID',
                        dept: 'Peer Academic Department'
                    }
                }
            }
        };

function toAdvisingOfficeFromRole(roleLabel) {
  try {
    if (CONSTANTS.ADVISOR_OFFICE_ALIASES && CONSTANTS.ADVISOR_OFFICE_ALIASES[roleLabel]) {
      return CONSTANTS.ADVISOR_OFFICE_ALIASES[roleLabel];
    }
  } catch(e) {}
  return (roleLabel || '')
    .replace(/\s*\b(Advisor|Counselor)\b\s*$/i, '')
    .replace(/\s+-\s+$/,'')
    .trim();
}



        // GLOBAL STATE
        const appState = {
            data: { main: null, advisor: null, faculty: null, peer: null },
            processedData: null,
            analytics: null,  // Store analytics for recalculation
            selectedAdvisors: new Set()  // Track which advisors are selected
        };

        let selectedCategories = {};
        
        // Initialize all advisors as selected
        function initializeSelectedAdvisors() {
            if (appState.analytics && appState.analytics.advising && appState.analytics.advising.advisorAssignmentsFlat) {
                appState.analytics.advising.advisorAssignmentsFlat.forEach(item => {
                    const advisorKey = `${item.advisor}|${item.offices}`;
                    appState.selectedAdvisors.add(advisorKey);
                });
            }
        }
        
        // Toggle advisor selection
        window.toggleAdvisor = function(advisorKey) {
            if (appState.selectedAdvisors.has(advisorKey)) {
                appState.selectedAdvisors.delete(advisorKey);
            } else {
                appState.selectedAdvisors.add(advisorKey);
            }
            // Recalculate and update the median table
            updateMedianTable();
        };
        
        // Select all advisors
        window.selectAllAdvisors = function() {
            document.querySelectorAll('input[id^="advisor_checkbox_"]').forEach(cb => {
                cb.checked = true;
            });
            // Rebuild the selected set
            if (appState.analytics && appState.analytics.advising && appState.analytics.advising.advisorAssignmentsFlat) {
                appState.selectedAdvisors.clear();
                appState.analytics.advising.advisorAssignmentsFlat.forEach(item => {
                    const advisorKey = `${item.advisor}|${item.offices}`;
                    appState.selectedAdvisors.add(advisorKey);
                });
            }
            updateMedianTable();
        };
        
        // Deselect all advisors
        window.deselectAllAdvisors = function() {
            document.querySelectorAll('input[id^="advisor_checkbox_"]').forEach(cb => {
                cb.checked = false;
            });
            appState.selectedAdvisors.clear();
            updateMedianTable();
        };
        
        // Update the median table based on selected advisors
        function updateMedianTable() {
            if (!appState.analytics || !appState.analytics.advising) return;
            
            // Get the container for median tables
            const container = document.getElementById('medianCaseloadContainer');
            if (!container) return;
            
            // Regenerate the median tables with current selections
            container.innerHTML = generateMedianCaseloadTables(
                appState.analytics.advising.officeDetailedStats,
                appState.analytics.advising.advisorAssignmentsFlat,
                appState.analytics.advising.studentAdvisorOfficeMap
            );
        }
        
        // Build the actual HTML for median tables
        function buildMedianTableHTML(officeStats) {
            // This function would generate the same HTML as in generateAdvisingDashboard
            // but with the filtered data
            // For brevity, returning a simple message - in production, this would generate the full table
            let html = '';
            
            const mainOffices = Object.entries(officeStats).filter(([_, stats]) => !stats.isOther).sort(([a], [b]) => a.localeCompare(b));
            
            if (mainOffices.length > 0) {
                // Generate the main offices table
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
                // ... table generation code similar to generateAdvisingDashboard
                html += '</table>';
            }
            
            return html;
        }
        
        // Generate median caseload tables (can be called initially and for updates)
        function generateMedianCaseloadTables(officeDetailedStats, advisorAssignmentsFlat, studentAdvisorOfficeMap) {
            if (!officeDetailedStats) return '';
            
            let html = '<h4 style="color:#333; margin: 24px 0 10px;">üìä Median Caseload by Advising Office</h4>';
            html += '<div style="font-size:12px; color:#6c757d; margin-bottom:10px;">This table shows the median number of students per advisor in each advising office. <strong>Use the checkboxes in the Advisor Assignments table to include/exclude advisors from these calculations.</strong></div>';
            
            const officeStats = {};
            const otherOffices = new Set([
                'ECI - College Now',
                'ECI - Energy Tech HS',
                'ECI - International HS',
                'ECI - Middle College HS',
                'Health Sciences/Paramedic'
            ]);
            
            // Build office stats with dynamic student counts based on selected advisors
            Object.entries(officeDetailedStats).forEach(([office, stats]) => {
                // Determine which students are still covered in this office based on selected advisors
                let exclusiveCount = 0;
                let sharedCount = 0;
                
                if (studentAdvisorOfficeMap && appState.selectedAdvisors.size > 0) {
                    // Track which students are still covered in this office
                    const coveredStudents = new Set();
                    
                    // Go through each student in the map
                    Object.entries(studentAdvisorOfficeMap).forEach(([studentId, studentData]) => {
                        const officeData = studentData.offices[office];
                        if (!officeData) return;
                        
                        // Check if at least one of this student's advisors in this office is selected
                        let hasSelectedAdvisor = false;
                        officeData.advisors.forEach(advisorName => {
                            // Find matching advisor in flat list to get their key
                            const advisorData = advisorAssignmentsFlat.find(item => 
                                item.advisor === advisorName && item.offices.includes(office)
                            );
                            
                            if (advisorData) {
                                const key = `${advisorData.advisor}|${advisorData.offices}`;
                                if (appState.selectedAdvisors.has(key)) {
                                    hasSelectedAdvisor = true;
                                }
                            }
                        });
                        
                        // If student has at least one selected advisor in this office, count them
                        if (hasSelectedAdvisor) {
                            coveredStudents.add(studentId);
                            if (studentData.isExclusive) {
                                exclusiveCount++;
                            } else {
                                sharedCount++;
                            }
                        }
                    });
                } else {
                    // No student map or no selections - use original stats
                    exclusiveCount = stats.exclusiveStudents;
                    sharedCount = stats.sharedStudents;
                }
                
                // Filter advisors based on selection
                const filteredCaseloads = [];
                let filteredAdvisorCount = 0;
                
                Object.entries(stats.advisorCaseloads).forEach(([advisor, counts]) => {
                    // Find the advisor in the flat list to get their key
                    let isSelected = true; // Default to selected if not in UI yet
                    
                    if (advisorAssignmentsFlat && appState.selectedAdvisors.size > 0) {
                        const advisorData = advisorAssignmentsFlat.find(item => 
                            item.advisor === advisor && item.offices.includes(office)
                        );
                        
                        if (advisorData) {
                            const key = `${advisorData.advisor}|${advisorData.offices}`;
                            isSelected = appState.selectedAdvisors.has(key);
                        }
                    }
                    
                    if (isSelected) {
                        filteredCaseloads.push(counts.total);
                        filteredAdvisorCount++;
                    }
                });
                
                // Calculate median for selected advisors
                let median = 0;
                if (filteredCaseloads.length > 0) {
                    const sorted = [...filteredCaseloads].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    median = sorted.length % 2 === 0 
                        ? ((sorted[mid - 1] + sorted[mid]) / 2).toFixed(1)
                        : sorted[mid].toFixed(1);
                }
                
                officeStats[office] = {
                    advisors: filteredAdvisorCount,
                    students: exclusiveCount + sharedCount,
                    exclusive: exclusiveCount,
                    shared: sharedCount,
                    median: median,
                    caseloads: filteredCaseloads,
                    isOther: otherOffices.has(office)
                };
            });
            
            // Split into main and other offices
            const mainOffices = Object.entries(officeStats).filter(([_, stats]) => !stats.isOther).sort(([a], [b]) => a.localeCompare(b));
            const otherOfficesList = Object.entries(officeStats).filter(([_, stats]) => stats.isOther).sort(([a], [b]) => a.localeCompare(b));
            
            // Main offices table
            if (mainOffices.length > 0) {
                const medianHeaders = [
                    { title: 'Advising Office', align: 'left' },
                    { title: 'Selected Advisors', align: 'right' },
                    { title: 'Exclusive Students', align: 'right' },
                    { title: 'Shared Students', align: 'right' },
                    { title: 'Total Students', align: 'right' },
                    { title: 'Median Caseload', align: 'right' }
                ];
                
                let totalAdvisors = 0, totalExclusive = 0, totalShared = 0, totalStudents = 0;
                const allCaseloads = [];
                
                const medianRows = mainOffices.map(([office, stats]) => {
                    totalAdvisors += stats.advisors;
                    totalExclusive += stats.exclusive;
                    totalShared += stats.shared;
                    totalStudents += stats.students;
                    allCaseloads.push(...stats.caseloads);
                    
                    return {
                        cells: [
                            { content: office },
                            { content: stats.advisors, style: 'text-align:right;' },
                            { content: stats.exclusive, style: 'text-align:right;' },
                            { content: stats.shared, style: 'text-align:right;' },
                            { content: stats.students, style: 'text-align:right; font-weight:bold;' },
                            { content: stats.advisors > 0 ? stats.median : 'N/A', style: 'text-align:right; font-weight:bold;' }
                        ]
                    };
                });
                
                // Calculate overall median from all caseloads
                let overallMedian = '0.0';
                if (allCaseloads.length > 0) {
                    const sorted = [...allCaseloads].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    overallMedian = sorted.length % 2 === 0 
                        ? ((sorted[mid - 1] + sorted[mid]) / 2).toFixed(1)
                        : sorted[mid].toFixed(1);
                }
                
                html += utils.createTable(medianHeaders, medianRows, {
                    grandTotal: {
                        color: '#333',
                        cells: [
                            { content: 'GRAND TOTAL' },
                            { content: totalAdvisors, align: 'right' },
                            { content: totalExclusive, align: 'right' },
                            { content: totalShared, align: 'right' },
                            { content: totalStudents, align: 'right' },
                            { content: totalAdvisors > 0 ? overallMedian : 'N/A', align: 'right' }
                        ]
                    }
                });
            }
            
            // Other offices table
            if (otherOfficesList.length > 0) {
                html += '<h4 style="color:#333; margin: 24px 0 10px;">üìä Median Caseload by Advising Office (other)</h4>';
                html += '<div style="font-size:12px; color:#6c757d; margin-bottom:10px;">ECI offices and specialized programs.</div>';
                
                const otherHeaders = [
                    { title: 'Advising Office', align: 'left' },
                    { title: 'Selected Advisors', align: 'right' },
                    { title: 'Exclusive Students', align: 'right' },
                    { title: 'Shared Students', align: 'right' },
                    { title: 'Total Students', align: 'right' },
                    { title: 'Median Caseload', align: 'right' }
                ];
                
                let otherTotalAdvisors = 0, otherTotalExclusive = 0, otherTotalShared = 0, otherTotalStudents = 0;
                const otherAllCaseloads = [];
                
                const otherRows = otherOfficesList.map(([office, stats]) => {
                    otherTotalAdvisors += stats.advisors;
                    otherTotalExclusive += stats.exclusive;
                    otherTotalShared += stats.shared;
                    otherTotalStudents += stats.students;
                    otherAllCaseloads.push(...stats.caseloads);
                    
                    return {
                        cells: [
                            { content: office },
                            { content: stats.advisors, style: 'text-align:right;' },
                            { content: stats.exclusive, style: 'text-align:right;' },
                            { content: stats.shared, style: 'text-align:right;' },
                            { content: stats.students, style: 'text-align:right; font-weight:bold;' },
                            { content: stats.advisors > 0 ? stats.median : 'N/A', style: 'text-align:right; font-weight:bold;' }
                        ]
                    };
                });
                
                // Calculate overall median from all other caseloads
                let otherOverallMedian = '0.0';
                if (otherAllCaseloads.length > 0) {
                    const sorted = [...otherAllCaseloads].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    otherOverallMedian = sorted.length % 2 === 0 
                        ? ((sorted[mid - 1] + sorted[mid]) / 2).toFixed(1)
                        : sorted[mid].toFixed(1);
                }
                
                html += utils.createTable(otherHeaders, otherRows, {
                    grandTotal: {
                        color: '#333',
                        cells: [
                            { content: 'GRAND TOTAL' },
                            { content: otherTotalAdvisors, align: 'right' },
                            { content: otherTotalExclusive, align: 'right' },
                            { content: otherTotalShared, align: 'right' },
                            { content: otherTotalStudents, align: 'right' },
                            { content: otherTotalAdvisors > 0 ? otherOverallMedian : 'N/A', align: 'right' }
                        ]
                    }
                });
            }
            
            if (Object.keys(officeStats).length === 0) {
                html += '<div style="padding:15px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:5px; color:#6c757d;">No office assignments found for median calculation.</div>';
            }
            
            return html;
        }
        
        // Make function globally accessible for updates
        window.generateMedianCaseloadTables = generateMedianCaseloadTables;

        // UTILITY FUNCTIONS
        const utils = {
            showStatus(message, type) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = 'status ' + type;
                statusElement.style.display = 'block';
            },

            showProgress(show = true) {
                const progressContainer = document.getElementById('progressContainer');
                const statusElement = document.getElementById('status');
                if (show) {
                    progressContainer.style.display = 'block';
                    statusElement.style.display = 'none';
                } else {
                    progressContainer.style.display = 'none';
                }
            },

            updateProgress(percentage, text, details = '') {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const progressDetails = document.getElementById('progressDetails');
                
                progressFill.style.width = percentage + '%';
                progressText.textContent = text;
                progressDetails.textContent = details;
            },

            findColumn(headers, possibleNames) {
                for (const name of possibleNames) {
                    const index = headers.findIndex(h => h.toString().trim().toLowerCase() === name.toLowerCase());
                    if (index !== -1) return { name, index };
                }
                return null;
            },

            extractStaffByRole(staffList, role) {
                return staffList.split(';')
                    .map(s => s.trim())
                    .filter(entry => {
                        const entryLower = entry.toLowerCase();
                        const roleLower = role.toLowerCase();
                        // Handle special cases for health faculty advisors
                        if (roleLower === 'clinical health faculty advisor') {
                            return entryLower.includes('(clinical health faculty advisor)') || 
                                   entryLower.includes('(health sciences faculty advisor)');
                        }
                        return entryLower.includes(`(${roleLower})`);
                    })
                    .map(entry => entry.split('(')[0].trim())
                    .join('; ') || null;
            },

            extractProfessionalAdvisorAndOffice(staffList) {
                const entries = staffList.split(';').map(s => s.trim());
                const matching = entries.filter(entry => 
                    CONSTANTS.ROLES.ADVISOR.some(role => entry.toLowerCase().includes(`(${role})`))
                );
                
                let advisors = matching.map(entry => entry.split('(')[0].trim());
                let offices = matching.map(entry => {
                    const match = entry.match(/\((.*?)\)/);
                    if (!match) return '';
                    let office = match[1];
                    office = office.replace(/ (advisor|counselor)$/i, '');
                    return office;
                });

                
                // --- JG tweak: handle specific Paramedic Advisor case ---
                try {
                    if (Array.isArray(entries) && entries.includes('Freire, Jazmine (Paramedic Advisor)')) {
                        // Add Professional Advisor name as "Freire, Jazmine" (Last, First)
                        if (Array.isArray(advisors)) advisors.push('Freire, Jazmine');
                        // Add Advising Office label exactly as requested
                        if (Array.isArray(offices)) offices.push('Health Sciences/Paramedic');
                    }
                    // Ensure uniqueness
                    if (Array.isArray(advisors)) advisors = Array.from(new Set(advisors));
                    if (Array.isArray(offices)) offices = Array.from(new Set(offices));
                } catch (e) {
                    console.warn('Paramedic Advisor special-case handling failed:', e);
                }
        return {
                    professionalAdvisor: advisors.join('; ') || null,
                    advisingOffice: offices.join('; ') || null
                };
            },

            determineAcademicStanding(category) {
                const standings = ['Academic Suspension', 'Dismissed', 'Extended Probation', 'Probation', 'Good Academic Standing'];
                return standings.find(standing => category.includes(standing)) || null;
            },

            extractMajorFromCategory(category) {
                const majorItem = category.split(',').find(item => item.trim().startsWith('Major:'));
                return majorItem ? majorItem.replace('Major: ', '').trim() : null;
            },

            createTable(headers, rows, options = {}) {
                const { grandTotal, className = '' } = options;
                let html = `<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;" class="${className}">`;
                
                // Headers
                html += '<thead><tr style="background-color: #f8f9fa;">';
                headers.forEach(header => {
                    html += `<th style="border: 1px solid #dee2e6; padding: 10px; text-align: ${header.align || 'left'};">${header.title}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Rows
                rows.forEach((row, index) => {
                    const rowStyle = row.style || (index % 2 === 0 ? 'background-color: #f8f9fa;' : '');
                    html += `<tr style="${rowStyle}">`;
                    row.cells.forEach(cell => {
                        const cellStyle = `border: 1px solid #dee2e6; padding: 8px; ${cell.style || ''}`;
                        const attrs = cell.rowspan ? `rowspan="${cell.rowspan}"` : '';
                        const colspanAttr = cell.colspan ? `colspan="${cell.colspan}"` : '';
                        html += `<td style="${cellStyle}" ${attrs} ${colspanAttr}>${cell.content}</td>`;
                    });
                    html += '</tr>';
                });

                // Grand total row
                if (grandTotal) {
                    html += `<tr style="background-color: ${grandTotal.color}; color: white; font-weight: bold;">`;
                    grandTotal.cells.forEach(cell => {
                        const attrs = cell.colspan ? `colspan="${cell.colspan}"` : '';
                        html += `<td style="border: 1px solid #dee2e6; padding: 8px; text-align: ${cell.align || 'left'};" ${attrs}>${cell.content}</td>`;
                    });
                    html += '</tr>';
                }

                html += '</tbody></table>';
                return html;
            }
        };

        // DEPARTMENT MAPPINGS
        const departmentMappings = {
            'BAT': ['Accounting AS', 'Business Administration AS', 'Business Administration AS - General', 'Business Administration AS - Facilities Management', 'Business Administration AS - Healthcare Management', 'Paralegal CERT', 'Paralegal Studies AAS', 'Hosp. Tourism & Events Mgmt AS'],
            'COMMHLTH': ['Human Services Mental Hlth AA', 'Human Services Mental Hlth AA - Health Navigation', 'Nutrition & Culinary Mgmt AAS', 'Nutrition & Culinary Mgmt AAS - Culinary Management', 'Nutrition & Culinary Mgmt AAS - Nutrition', 'Public and Community Health AS', 'Therapeutic Recreation AS'],
            'ELA': ['Edu Assoc Bilingual Child AA', 'Education AA', 'Education AA - Adolescent Educ Social Science', 'Education AA - Adolescent Education English', 'Education AA - Adolescent Education Math', 'Education AA - Adolescent Education Science', 'Education AA - Adolescent Education Spanish', 'Education AA - Childhood Education', 'Education AA - Early Childhood Education', 'Social Science and Hum AA - Deaf Studies', 'Social Science and Hum AA - International', 'Social Science and Hum AA - Japanese', 'Social Science and Hum AA - Latin Amer Stud', 'Spanish-English Translation AA', 'Social Science and Hum AA - TESOL Linguistics'],
            'ENG': ['English AA', 'English AA - General', 'English AA - Creative Writing', 'Social Science and Hum AA - Journalism'],
            'HLTSCI': ['Nursing AAS', 'Occup Thrpy Assistant AAS', 'Paramedic AAS', 'Physical Therapist Asst AAS', 'Radiologic Technology AAS', 'Veterinary Technology AAS', 'Practical Nursing CERT', 'Undeclared Health Nursing AAS', 'Undeclared Pre-Health Sci AAS', 'Undeclared Pre-Health Sci AAS - Nursing', 'Undeclared Pre-Health Sci AAS - Occupational Therapy Assistant', 'Undeclared Pre-Health Sci AAS - Paramedic', 'Undeclared Pre-Health Sci AAS - Physical Therapist Assistant', 'Undeclared Pre-Health Sci AAS - Radiologic Technology', 'Undeclared Pre-Health Sci AAS - Veterinary Technology'],
            'HUM': ['Communication Studies AA', 'Communication Studies AA - Communication Generalist', 'Communication Studies AA - Mass Communication', 'Communication Studies AA - Digital Comm & Society', 'Communication Studies AA - Pub Relations Strategic Comm', 'Communication Studies AA - Public Relations', 'Communication Studies AA - Speech Pathology', 'Film and Television AA', 'Fine Arts AS', 'Fine Arts AS - Design Studies', 'Fine Arts AS - General', 'Industrial Design Tech AAS', 'Music Performance AS', 'Music Recording Technology AAS', 'Digital Media Arts CERT', 'New Media Technology AAS', 'New Media Technology AAS - Digital Journalism', 'New Media Technology AAS - Digital Media', 'New Media Technology AAS - Entrepreneurship', 'Philosophy AA', 'Commercial Photography CERT', 'Photography AAS', 'Photography AAS - Fine Arts Option', 'Photography AAS - General', 'Theater AS'],
            'LIBARTS': ['Liberal Arts Math and Sci AS', 'Liberal Arts Math and Sci AS - Applied Mathematics', 'Liberal Arts Math and Sci AS - General Math and Science', 'Social Science and Hum AA', 'Social Science and Hum AA - Ethnic Studies', 'Social Science and Hum AA - General', 'Social Science and Hum AA - Health Humanities', 'Social Science and Hum AA - Women'],
            'MEC': ['Cybersecurity AAS', 'Cybersecurity CERT', 'Computer Science AS', 'Computer Technology AAS', 'Computer Technology AAS - Telecommunication Option', 'Network & Info Sec CERT', 'Network Admin & Info Sec AAS', 'Network Admin & Info Sec AAS - Network Admin & Secur Opt', 'Programming/Software Dev AAS', 'Programming/Software Dev AAS - Web Programming', 'Electrical Engineering AS', 'Energy Technician AAS', 'Energy Technician AAS - Electrical', 'Energy Technician AAS - Mechanical', 'Engineering Sci Civil Eng AS', 'Mechanical Engineering AS', 'Mechanical Engineering AS - Earth Sys Sci and Envrnmtl Eng', 'Mechanical Engineering AS - General'],
            'NAS': ['Biology AS', 'Biology AS - Biotechnology', 'Biology AS - General Biology', 'Environmental Science AS', 'Environmental Science AS - Animal Sciences', 'Environmental Science AS - General', 'Environmental Science AS - Sustainable Urban Agriculture', 'Physical Sciences AS', 'Physical Sciences AS - Chemistry', 'Physical Sciences AS - Physics'],
            'SOCSCI': ['Criminal Justice AS', 'Social Science and Hum AA - History', 'Social Science and Hum AA - Political Scienc', 'Psychology AA']
        };

        // Major TO STUDENT ACADEMIC DEPARTMENT_SUB MAPPING
        // Based on the exact values from "Major and Student Academic Department_sub.csv" file
        const majorToStudentDeptSubMappings = {
            'Accounting AS': 'BAT-ACCT',
            'Business Administration AS': 'BAT',
            'Business Administration AS - General': 'BAT',
            'Business Administration AS - Facilities Management': 'BAT',
            'Business Administration AS - Healthcare Management': 'BAT-HLTH',
            'Paralegal CERT': 'BAT-PARALEGAL',
            'Paralegal Studies AAS': 'BAT-PARALEGAL',
            'Hosp. Tourism & Events Mgmt AS': 'BAT-TOURISM',
            'Human Services Mental Hlth AA': 'COMMHLTH-HUM',
            'Human Services Mental Hlth AA - Health Navigation': 'COMMHLTH-HUM',
            'Nutrition & Culinary Mgmt AAS': 'COMMHLTH-NUT',
            'Nutrition & Culinary Mgmt AAS - Culinary Management': 'COMMHLTH-NUT',
            'Nutrition & Culinary Mgmt AAS - Nutrition': 'COMMHLTH-NUT',
            'Public and Community Health AS': 'COMMHLTH-PUB',
            'Therapeutic Recreation AS': 'COMMHLTH-THER',
            'Social Science and Hum AA - Deaf Studies': 'ELA-DEAF',
            'Edu Assoc Bilingual Child AA': 'ELA-EDU',
            'Education AA': 'ELA-EDU',
            'Education AA - Adolescent Educ Social Science': 'ELA-EDU',
            'Education AA - Adolescent Education English': 'ELA-EDU',
            'Education AA - Adolescent Education Math': 'ELA-EDU',
            'Education AA - Adolescent Education Science': 'ELA-EDU',
            'Education AA - Adolescent Education Spanish': 'ELA-EDU',
            'Education AA - Childhood Education': 'ELA-EDU',
            'Education AA - Early Childhood Education': 'ELA-EDU',
            'Social Science and Hum AA - International': 'ELA-INTN',
            'Social Science and Hum AA - Japanese': 'ELA-JAPAN',
            'Social Science and Hum AA - Latin Amer Stud': 'ELA-LATAM',
            'Spanish-English Translation AA': 'ELA-SPANTRAN',
            'Social Science and Hum AA - TESOL Linguistics': 'ELA-TESOL',
            'English AA': 'ENG-GEN',
            'English AA - General': 'ENG-GEN',
            'English AA - Creative Writing': 'ENG-CREATIVE',
            'Social Science and Hum AA - Journalism': 'ENG-JOURN',
            'Practical Nursing CERT': 'HLTSCI-LPN',
            'Nursing AAS': 'HLTSCI-RN',
            'Occup Thrpy Assistant AAS': 'HLTSCI-OTA',
            'Paramedic AAS': 'HLTSCI-PARA',
            'Physical Therapist Asst AAS': 'HLTSCI-PTA',
            'Radiologic Technology AAS': 'HLTSCI-RAD',
            'Undeclared Health Nursing AAS': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Nursing': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Occupational Therapy Assistant': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Paramedic': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Physical Therapist Assistant': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Radiologic Technology': 'HLTSCI-UND',
            'Undeclared Pre-Health Sci AAS - Veterinary Technology': 'HLTSCI-UND',
            'Veterinary Technology AAS': 'HLTSCI-VET',
            'Communication Studies AA': 'HUM-COMM',
            'Communication Studies AA - Communication Generalist': 'HUM-COMM',
            'Communication Studies AA - Digital Comm & Society': 'HUM-COMM',
            'Communication Studies AA - Pub Relations Strategic Comm': 'HUM-COMM',
            'Communication Studies AA - Public Relations': 'HUM-COMM',
            'Communication Studies AA - Speech Pathology': 'HUM-COMMSPEECH',
            'Film and Television AA': 'HUM-FILM',
            'Fine Arts AS': 'HUM-FINEART',
            'Fine Arts AS - Design Studies': 'HUM-FINEART',
            'Fine Arts AS - General': 'HUM-FINEART',
            'Industrial Design Tech AAS': 'HUM-IND',
            'Music Performance AS': 'HUM-MUSPER',
            'Music Recording Technology AAS': 'HUM-MUSREC',
            'Digital Media Arts CERT': 'HUM-NEWMEDIA',
            'New Media Technology AAS': 'HUM-NEWMEDIA',
            'New Media Technology AAS - Digital Journalism': 'HUM-NEWMEDIA',
            'New Media Technology AAS - Digital Media': 'HUM-NEWMEDIA',
            'New Media Technology AAS - Entrepreneurship': 'HUM-NEWMEDIA',
            'Philosophy AA': 'HUM-PHIL',
            'Commercial Photography CERT': 'HUM-PHOTO',
            'Photography AAS': 'HUM-PHOTO',
            'Photography AAS - Fine Arts Option': 'HUM-PHOTO',
            'Photography AAS - General': 'HUM-PHOTO',
            'Theater AS': 'HUM-THEAT',
            'Liberal Arts Math and Sci AS - Applied Mathematics': 'LIBARTS-APPLMAT',
            'Social Science and Hum AA - Ethnic Studies': 'LIBARTS-SSH',
            'Social Science and Hum AA - Health Humanities': 'LIBARTS-SSH',
            'Liberal Arts Math and Sci AS': 'LIBARTS-MS',
            'Liberal Arts Math and Sci AS - General Math and Science': 'LIBARTS-MS',
            'Social Science and Hum AA': 'LIBARTS-SSH',
            'Social Science and Hum AA - General': 'LIBARTS-SSH',
            'Social Science and Hum AA - Women': 'LIBARTS-WGS',
            'Cybersecurity AAS': 'MEC-COMP',
            'Cybersecurity CERT': 'MEC-COMP',
            'Computer Science AS': 'MEC-COMP',
            'Computer Technology AAS': 'MEC-COMP',
            'Computer Technology AAS - Telecommunication Option': 'MEC-COMP',
            'Network & Info Sec CERT': 'MEC-COMP',
            'Network Admin & Info Sec AAS': 'MEC-COMP',
            'Network Admin & Info Sec AAS - Network Admin & Secur Opt': 'MEC-COMP',
            'Programming/Software Dev AAS': 'MEC-COMP',
            'Programming/Software Dev AAS - Web Programming': 'MEC-COMP',
            'Electrical Engineering AS': 'MEC-ENG',
            'Energy Technician AAS': 'MEC-ENG',
            'Energy Technician AAS - Electrical': 'MEC-ENG',
            'Energy Technician AAS - Mechanical': 'MEC-ENG',
            'Engineering Sci Civil Eng AS': 'MEC-ENG',
            'Mechanical Engineering AS': 'MEC-ENG',
            'Mechanical Engineering AS - Earth Sys Sci and Envrnmtl Eng': 'MEC-ENG',
            'Mechanical Engineering AS - General': 'MEC-ENG',
            'Biology AS': 'NAS-BIO',
            'Biology AS - Biotechnology': 'NAS-BIO',
            'Biology AS - General Biology': 'NAS-BIO',
            'Environmental Science AS': 'NAS-ENV',
            'Environmental Science AS - Animal Sciences': 'NAS-ENV',
            'Environmental Science AS - General': 'NAS-ENV',
            'Environmental Science AS - Sustainable Urban Agriculture': 'NAS-ENV',
            'Physical Sciences AS': 'NAS-PHYS',
            'Physical Sciences AS - Chemistry': 'NAS-PHYS',
            'Physical Sciences AS - Physics': 'NAS-PHYS',
            'Non Degree Undergraduate - College Now': 'NON-COLNOW',
            'Non Degree Undergraduate': 'NON-DEGREE',
            'CUNY Permit Undergraduate': 'NON-PERMIT',
            'Criminal Justice AS': 'SOCSCI-CRIM',
            'Social Science and Hum AA - History': 'SOCSCI-HIST',
            'Social Science and Hum AA - Political Scienc': 'SOCSCI-POLI',
            'Psychology AA': 'SOCSCI-PSY'
        };

        function mapToAcademicDepartment(major) {
            if (['CUNY Permit Undergraduate', 'Non Degree Undergraduate', 'Non Degree Undergraduate - College Now'].includes(major)) {
                return 'NONDEGREE';
            }
            
            for (const [dept, majors] of Object.entries(departmentMappings)) {
                if (majors.includes(major)) return dept;
            }
            return null;
        }

        function mapToStudentDeptSub(major) {
            return majorToStudentDeptSubMappings[major] || null;
        }

        // FILE HANDLING
        function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;

            const statusElement = document.getElementById(`${fileType}FileStatus`);
            statusElement.textContent = '‚è≥ Loading...';
            statusElement.style.backgroundColor = '#fff3cd';
            statusElement.style.color = '#856404';
            statusElement.classList.remove('loaded');

            Papa.parse(file, {
                complete: (results) => {
                    appState.data[fileType] = results.data;
                    statusElement.textContent = `‚úÖ ${file.name} loaded (${results.data.length} rows)`;
                    statusElement.style.backgroundColor = '#d4edda';
                    statusElement.style.color = '#155724';
                    statusElement.classList.add('loaded');
                    checkAllFilesLoaded();
                },
                error: (error) => {
                    utils.showStatus(`Error loading ${fileType} file: ${error.message}`, 'error');
                    statusElement.textContent = '‚ùå Error loading file';
                    statusElement.style.backgroundColor = '#f8d7da';
                    statusElement.style.color = '#721c24';
                }
            });
        }

        function checkAllFilesLoaded() {
            const processBtn = document.getElementById('processBtn');
            if (appState.data.main) {
                processBtn.disabled = false;
                processBtn.style.backgroundColor = '#007bff';
                processBtn.style.boxShadow = '0 4px 8px rgba(0,123,255,0.3)';
                processBtn.style.cursor = 'pointer';
                
                const loadedFiles = Object.entries(appState.data)
                    .filter(([_, data]) => data)
                    .map(([type, _]) => `${type} file`);
                utils.showStatus(loadedFiles.join(', ') + ' loaded. Ready to process!', 'success');
            } else {
                processBtn.disabled = true;
                processBtn.style.backgroundColor = '#6c757d';
                processBtn.style.boxShadow = '0 4px 8px rgba(108,117,125,0.3)';
                processBtn.style.cursor = 'not-allowed';
            }
        }

        // DATA PROCESSING
        function processFiles() {
            utils.showProgress(true);
            utils.updateProgress(0, 'Starting file processing...', 'Initializing data structures');
            
            // Small delay to ensure UI updates
            setTimeout(() => {
                try {
                    utils.updateProgress(10, 'Validating main data file...', 'Checking file structure and required columns');
                    
                    const mainData = appState.data.main;
                    if (!mainData || mainData.length < 3) {
                        throw new Error('Main data appears to be too short or missing');
                    }
                    
                    let data = mainData.slice(2);
                    const headers = data[0].map(h => h.trim());

                    // Normalize headers and apply canonical names (e.g., rename raw 'Major' -> 'Navigate Major')
                    const aliasMap = new Map([
                        ['student id', CONSTANTS.COLUMNS.STUDENT_ID],
                        ['assigned staff', CONSTANTS.COLUMNS.ASSIGNED_STAFF],
                        ['category', CONSTANTS.COLUMNS.CATEGORY],
                        ['major', CONSTANTS.COLUMNS.NAV_M],
                        ['navigate major', CONSTANTS.COLUMNS.NAV_M],
                        ['nav_m', CONSTANTS.COLUMNS.NAV_M],
                        ['professional advisor', CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR],
                        ['advising office', CONSTANTS.COLUMNS.ADVISING_OFFICE],
                        ['faculty mentor', CONSTANTS.COLUMNS.FACULTY_MENTOR],
                        ['peer advisor', CONSTANTS.COLUMNS.PEER_ADVISOR],
                        ['program director', CONSTANTS.COLUMNS.PROGRAM_DIRECTOR],
                        ['librarian', CONSTANTS.COLUMNS.LIBRARIAN]
                    ]);
                    const normalizedHeaders = headers.map(h => {
                        const key = h.trim().toLowerCase();
                        return aliasMap.get(key) || h.trim();
                    });

                    data = data.slice(1);
                    
                    const requiredColumns = [CONSTANTS.COLUMNS.STUDENT_ID, CONSTANTS.COLUMNS.ASSIGNED_STAFF, CONSTANTS.COLUMNS.CATEGORY];
                    const missingColumns = requiredColumns.filter(reqCol => 
                        !headers.find(header => header.toLowerCase().includes(reqCol.toLowerCase()))
                    );
                    
                    if (missingColumns.length > 0) {
                        throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
                    }
                    
                    utils.updateProgress(20, 'Creating student records...', `Processing ${data.length} student records`);
                    
                    let records = data.map(row => {
                        const obj = {};
                        normalizedHeaders.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    }).filter(record => record[CONSTANTS.COLUMNS.STUDENT_ID]?.toString().trim());

                    utils.updateProgress(35, 'Extracting staff assignments...', 'Processing advisor, faculty, and peer assignments');
                    
                    records = records.map(record => {
                        const advisorInfo = utils.extractProfessionalAdvisorAndOffice(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '');
                        record[CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR] = advisorInfo.professionalAdvisor;
                        
                        // Start with the office extracted from Assigned Staff
                        let advisingOffices = advisorInfo.advisingOffice ? advisorInfo.advisingOffice.split(';').map(o => o.trim()) : [];
                        
                        // Check Degree column for "NA" -> add "Nondegree"
                        const degree = record['Degree'] || '';
                        // Check the raw Major column (which is mapped to NAV_M/Navigate Major)
                        const rawMajor = record[CONSTANTS.COLUMNS.NAV_M] || '';
                        // Check Category for clinical course enrollment
                        const category = record[CONSTANTS.COLUMNS.CATEGORY] || '';
                        
                        // Determine if we need to add special office values
                        let addNondegree = false;
                        let addPermit = false;
                        let addClinical = false;
                        
                        if (degree.trim().toUpperCase() === 'NA') {
                            addNondegree = true;
                        }
                        
                        // Check raw Major column (NAV_M) for special values
                        if (rawMajor.includes('Non Degree Undergraduate')) {
                            addNondegree = true;
                        }
                        if (rawMajor.includes('CUNY Permit Undergraduate')) {
                            addPermit = true;
                        }
                        
                        // Check Category for clinical course enrollment
                        if (category.toLowerCase().includes('enrolled in any clinical course')) {
                            addClinical = true;
                        }
                        
                        // Add special values at the beginning (avoiding duplicates)
                        const specialOffices = [];
                        if (addClinical && !advisingOffices.includes('Enrolled in Clinical')) {
                            specialOffices.push('Enrolled in Clinical');
                        }
                        if (addNondegree && !advisingOffices.includes('Nondegree')) {
                            specialOffices.push('Nondegree');
                        }
                        if (addPermit && !advisingOffices.includes('Permit')) {
                            specialOffices.push('Permit');
                        }
                        
                        // Combine special offices at the beginning with existing offices
                        const allOffices = [...specialOffices, ...advisingOffices];
                        record[CONSTANTS.COLUMNS.ADVISING_OFFICE] = allOffices.length > 0 ? allOffices.join('; ') : null;
                        
                        const facultyMentor = utils.extractStaffByRole(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '', 'faculty mentor');
                        const clinicalAdvisor = utils.extractStaffByRole(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '', 'clinical health faculty advisor');
                        record[CONSTANTS.COLUMNS.FACULTY_MENTOR] = [facultyMentor, clinicalAdvisor].filter(Boolean).join('; ') || null;
                        
                        record[CONSTANTS.COLUMNS.PEER_ADVISOR] = utils.extractStaffByRole(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '', 'peer advisor');
                        record[CONSTANTS.COLUMNS.PROGRAM_DIRECTOR] = utils.extractStaffByRole(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '', 'program director');
                        record[CONSTANTS.COLUMNS.LIBRARIAN] = utils.extractStaffByRole(record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '', 'librarian');
                        
                        record[CONSTANTS.COLUMNS.ACADEMIC_STANDING] = utils.determineAcademicStanding(record[CONSTANTS.COLUMNS.CATEGORY] || '');
                        
                        // NAV_M is populated via header normalization from raw 'Major' -> 'Navigate Major'
                        record[CONSTANTS.COLUMNS.Major] = utils.extractMajorFromCategory(record[CONSTANTS.COLUMNS.CATEGORY] || '');
                        
                        // Generate Student Academic Department (depends on Major)
                        record[CONSTANTS.COLUMNS.STUDENT_DEPT] = mapToAcademicDepartment(record[CONSTANTS.COLUMNS.Major]);
                        
                        // Generate Student Academic Department_sub (depends on Major)
                        record[CONSTANTS.COLUMNS.STUDENT_DEPT_SUB] = mapToStudentDeptSub(record[CONSTANTS.COLUMNS.Major]);
                        
                        return record;
                    });
                    
                    utils.updateProgress(60, 'Performing data lookups...', 'Matching staff IDs and department information');
                    
                    records = performLookups(records);
                    appState.processedData = records;
                    
                    utils.updateProgress(80, 'Calculating analytics...', 'Generating dashboard statistics and insights');
                    
                    // Small delay to show analytics progress
                    setTimeout(() => {
                        utils.updateProgress(95, 'Building dashboard...', 'Creating interactive reports and visualizations');
                        
                        setTimeout(() => {
                            utils.updateProgress(100, 'Complete!', `Successfully processed ${records.length} student records`);
                            
                            setTimeout(() => {
                                utils.showProgress(false);
                                
                                // Store analytics in appState
                                appState.analytics = calculateAnalytics();
                                
                                // Initialize selected advisors
                                initializeSelectedAdvisors();
                                
                                showDashboard();
                            }, 500);
                        }, 300);
                    }, 200);
                    
                } catch (error) {
                    utils.showProgress(false);
                    utils.showStatus('Error processing files: ' + error.message, 'error');
                }
            }, 100);
        }

        // LOOKUP PROCESSING
        function createLookupMap(data, config) {
            const map = {};
            if (!data || data.length < 2) return map;
            
            const headers = data[0];
            const nameColumn = utils.findColumn(headers, config.nameColumns);
            const idColumn = utils.findColumn(headers, config.idColumns);
            
            if (!nameColumn) return map;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const name = row[nameColumn.index];
                if (name?.toString().trim()) {
                    const entry = { name: name.toString().trim() };
                    
                    if (idColumn) entry.id = row[idColumn.index];
                    
                    if (config.deptColumns) {
                        const deptColumn = utils.findColumn(headers, config.deptColumns);
                        if (deptColumn) entry.dept = row[deptColumn.index];
                    }
                    if (config.deptSubColumns) {
                        const deptSubColumn = utils.findColumn(headers, config.deptSubColumns);
                        if (deptSubColumn) entry.deptSub = row[deptSubColumn.index];
                    }
                    if (config.deptHomeColumns) {
                        const deptHomeColumn = utils.findColumn(headers, config.deptHomeColumns);
                        if (deptHomeColumn) entry.deptHome = row[deptHomeColumn.index];
                    }
                    
                    map[entry.name] = entry;
                }
            }
            
            return map;
        }

        function performLookups(records) {
            const lookupMaps = {};
            
            Object.entries(CONSTANTS.LOOKUP_CONFIGS).forEach(([type, config]) => {
                if (appState.data[type]) {
                    lookupMaps[type] = createLookupMap(appState.data[type], config);
                }
            });
            
            return records.map(record => {
                Object.entries(lookupMaps).forEach(([type, map]) => {
                    const config = CONSTANTS.LOOKUP_CONFIGS[type];
                    
                    if (type === 'advisor' && record[CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR]) {
                        const names = record[CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR].split(';').map(n => n.trim()).filter(Boolean);
                        const ids = names.map(name => map[name]?.id).filter(Boolean);
                        record[config.outputColumn] = ids.length > 0 ? ids.join('; ') : null;
                    }
                    
                    else if (type === 'faculty' && record[CONSTANTS.COLUMNS.FACULTY_MENTOR]) {
                        const names = record[CONSTANTS.COLUMNS.FACULTY_MENTOR].split(';').map(n => n.trim()).filter(Boolean);
                        const data = { ids: [], depts: [], deptSubs: [], deptHomes: [] };
                        
                        names.forEach(name => {
                            const lookup = map[name];
                            if (lookup) {
                                if (lookup.id) data.ids.push(lookup.id);
                                if (lookup.dept) data.depts.push(lookup.dept);
                                if (lookup.deptSub) data.deptSubs.push(lookup.deptSub);
                                if (lookup.deptHome) data.deptHomes.push(lookup.deptHome);
                            }
                        });
                        
                        record[config.outputColumns.id] = data.ids.length > 0 ? data.ids.join('; ') : null;
                        record[config.outputColumns.dept] = [...new Set(data.depts)].join('; ') || null;
                        record[config.outputColumns.deptSub] = [...new Set(data.deptSubs)].join('; ') || null;
                        record[config.outputColumns.deptHome] = [...new Set(data.deptHomes)].join('; ') || null;
                    }
                    
                    else if (type === 'peer' && record[CONSTANTS.COLUMNS.PEER_ADVISOR]) {
                        const names = record[CONSTANTS.COLUMNS.PEER_ADVISOR].split(';').map(n => n.trim()).filter(Boolean);
                        const ids = names.map(name => map[name]?.id).filter(Boolean);
                        const depts = [...new Set(names.map(name => map[name]?.dept).filter(Boolean))];
                        
                        record[config.outputColumns.id] = ids.length > 0 ? ids.join('; ') : null;
                        record[config.outputColumns.dept] = depts.length > 0 ? depts.join('; ') : null;
                    }
                });
                
                return record;
            });
        }

        // ANALYTICS
        function calculateAnalytics() {
            const data = appState.processedData;
            if (!data?.length) return {};

            const analytics = {};
            const officeCounts = {};
            let noOfficeCount = 0;
            const advisorsInCaseload = new Set();
            
            // Track breakdown of students with no office assignments
            let noOfficeBreakdown = {
                nonDegree: 0,
                enteringFreshman: 0,
                enteringTransfer: 0,
                readmit: 0,
                collegeNow: 0,
                potentialSeekCD: 0,
                conditionalSeekCD: 0,
                earlyCollege: 0,
                internationalStudent: 0,
                asapAccepts: 0,
                other: 0,
                otherCreditsBreakdown: {
                    null: 0,
                    zero: 0,
                    oneToFourteen: 0,
                    fifteenPlus: 0
                }
            };
            
            // Track single vs multiple advisors within single office
            const singleOfficeBreakdown = {
                singleAdvisor: 0,
                multipleAdvisors: 0,
                multipleAdvisorsByOffice: {}, // Track which offices have multiple advisor cases
                studentDetails: {} // Track which students fall into which category
            };
            
            data.forEach(record => {
                const office = record[CONSTANTS.COLUMNS.ADVISING_OFFICE];
                const advisor = record[CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR];
                const studentId = record[CONSTANTS.COLUMNS.STUDENT_ID];
                const category = record[CONSTANTS.COLUMNS.CATEGORY] || '';
                const major = record[CONSTANTS.COLUMNS.Major] || '';
                const studentDept = record[CONSTANTS.COLUMNS.STUDENT_DEPT] || '';
                
                if (office?.trim()) {
                    officeCounts[office] = (officeCounts[office] || 0) + 1;
                    
                    // Check if this is a single office assignment
                    if (!office.includes(';')) {
                        // Count the number of advisors for this single office
                        const advisorList = advisor ? advisor.split(';').map(a => a.trim()).filter(a => a) : [];
                        if (advisorList.length === 1) {
                            singleOfficeBreakdown.singleAdvisor++;
                            if (studentId) singleOfficeBreakdown.studentDetails[studentId] = 'singleAdvisor';
                        } else if (advisorList.length > 1) {
                            singleOfficeBreakdown.multipleAdvisors++;
                            if (studentId) singleOfficeBreakdown.studentDetails[studentId] = 'multipleAdvisors';
                            
                            // Track which office this is for
                            if (!singleOfficeBreakdown.multipleAdvisorsByOffice[office]) {
                                singleOfficeBreakdown.multipleAdvisorsByOffice[office] = 0;
                            }
                            singleOfficeBreakdown.multipleAdvisorsByOffice[office]++;
                        }
                    }
                } else {
                    noOfficeCount++;
                    
                    // Categorize students with no office assignments
                    if (studentDept === 'NONDEGREE' || major.toLowerCase().includes('non degree')) {
                        noOfficeBreakdown.nonDegree++;
                    } else if (category.includes('SG:FRSH-Entering Freshman')) {
                        noOfficeBreakdown.enteringFreshman++;
                    } else if (category.includes('SG:TRNS-Entering Transfer Student')) {
                        noOfficeBreakdown.enteringTransfer++;
                    } else if (category.includes('SG:RADM-Readmit')) {
                        noOfficeBreakdown.readmit++;
                    } else if (category.includes('SG:CNOW-College Now Student')) {
                        noOfficeBreakdown.collegeNow++;
                    } else if (category.includes('SG:SCD1-Potential SEEK/CD')) {
                        noOfficeBreakdown.potentialSeekCD++;
                    } else if (category.includes('SG:SCD2-Conditional SEEK/CD')) {
                        noOfficeBreakdown.conditionalSeekCD++;
                    } else if (category.includes('SG:ECI-Early College Initiative')) {
                        noOfficeBreakdown.earlyCollege++;
                    } else if (category.includes('SG:ISS-International Student Service')) {
                        noOfficeBreakdown.internationalStudent++;
                    } else if (category.includes('SG:ASP3-Accepts ASAP Invitation')) {
                        noOfficeBreakdown.asapAccepts++;
                    } else {
                        noOfficeBreakdown.other++;
                        
                        // Track earned credits breakdown for "other" students
                        const earnedCredits = record['Earned Credits'];
                        if (!earnedCredits || earnedCredits === '' || earnedCredits === null || earnedCredits === undefined) {
                            noOfficeBreakdown.otherCreditsBreakdown.null++;
                        } else {
                            const credits = parseFloat(earnedCredits);
                            if (isNaN(credits)) {
                                noOfficeBreakdown.otherCreditsBreakdown.null++;
                            } else if (credits === 0) {
                                noOfficeBreakdown.otherCreditsBreakdown.zero++;
                            } else if (credits >= 1 && credits <= 14) {
                                noOfficeBreakdown.otherCreditsBreakdown.oneToFourteen++;
                            } else if (credits >= 15) {
                                noOfficeBreakdown.otherCreditsBreakdown.fifteenPlus++;
                            } else {
                                noOfficeBreakdown.otherCreditsBreakdown.null++;
                            }
                        }
                    }
                }
                
                if (advisor?.trim()) {
                    advisor.split(';').forEach(name => {
                        const trimmedName = name.trim();
                        if (trimmedName) advisorsInCaseload.add(trimmedName);
                    });
                }
            });

            const sortedOffices = Object.entries(officeCounts).sort((a, b) => b[1] - a[1]);
            
            let advisorDataQuality = null;
            if (appState.data.advisor) {
                const advisorsInFile = new Set();
                const config = CONSTANTS.LOOKUP_CONFIGS.advisor;
                const lookupMap = createLookupMap(appState.data.advisor, config);
                Object.keys(lookupMap).forEach(name => advisorsInFile.add(name));
                
                advisorDataQuality = {
                    advisorsInCaseloadNotInFile: [...advisorsInCaseload].filter(advisor => !advisorsInFile.has(advisor)).sort(),
                    advisorsInFileNotInCaseload: [...advisorsInFile].filter(advisor => !advisorsInCaseload.has(advisor)).sort(),
                    totalAdvisorsInFile: advisorsInFile.size,
                    totalAdvisorsInCaseload: advisorsInCaseload.size
                };
            }
            
            
            // Helper function to normalize advisor names (remove extra spaces, standardize)
            const normalizeAdvisorName = (name) => {
                return name.trim().replace(/\s+/g, ' '); // Remove extra spaces
            };
            
            // === New: build Advisor Assignments by Advising Office ===
            const advisorAssignments = { single: {}, multiple: {} };
            const officeDetailedStats = {}; // Track exclusive vs shared per office
            const parseList = (str) => (str ? str.split(';').map(s => s.trim()).filter(Boolean) : []);
            
            // Track which student-office pairs we've already processed
            const processedStudentOffice = new Set();
            
            // First, build complete office statistics
            // IMPORTANT: Advisors are assigned to offices based on their ROLE, not student programs
            data.forEach(record => {
                const studentId = record[CONSTANTS.COLUMNS.STUDENT_ID];
                if (!studentId) return;
                
                const staffList = record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '';
                if (!staffList) return;
                
                // Parse all staff entries
                const staffEntries = staffList.split(';').map(s => s.trim()).filter(Boolean);
                
                // Extract advisors and their offices based on their ROLES
                const advisorsByOffice = {};
                
                staffEntries.forEach(entry => {
                    const entryLower = entry.toLowerCase();
                    
                    // Check each advisor role and assign to appropriate office
                    Object.entries(CONSTANTS.ROLES).forEach(([roleType, roles]) => {
                        if (roleType === 'ADVISOR') {
                            roles.forEach(role => {
                                if (entryLower.includes(`(${role})`)) {
                                    // Extract advisor name
                                    const name = entry.split('(')[0].trim();
                                    const normalizedName = normalizeAdvisorName(name);
                                    
                                    // Determine the office based on the role
                                    let office = '';
                                    if (role === 'asap advisor') office = 'ASAP';
                                    else if (role === 'college discovery counselor') office = 'College Discovery';
                                    else if (role === 'student advising services advisor') office = 'Student Advising Services';
                                    else if (role === 'international student services advisor') office = 'International Student Services';
                                    else if (role === 'careers in engineering advisor') office = 'Careers in Engineering';
                                    else if (role === 'cuny 2x tech academy advisor') office = 'CUNY 2X Tech Academy';
                                    else if (role === 'veteran services advisor') office = 'Veteran Services';
                                    else if (role === 'eci - college now advisor') office = 'ECI - College Now';
                                    else if (role === 'eci - energy tech hs advisor') office = 'ECI - Energy Tech HS';
                                    else if (role === 'eci - international hs advisor') office = 'ECI - International HS';
                                    else if (role === 'eci - middle college hs advisor') office = 'ECI - Middle College HS';
                                    else if (role === 'cuny start advisor') office = 'CUNY Start';
                                    else if (role === 'math start advisor') office = 'Math Start';
                                    
                                    if (office) {
                                        if (!advisorsByOffice[office]) {
                                            advisorsByOffice[office] = [];
                                        }
                                        advisorsByOffice[office].push(normalizedName);
                                    }
                                }
                            });
                        }
                    });
                });
                
                // Get unique offices for this student
                const offices = Object.keys(advisorsByOffice);
                const isExclusive = (offices.length === 1);
                
                // Process each office the student is enrolled in
                offices.forEach(office => {
                    // Create unique key for student-office pair
                    const studentOfficeKey = `${studentId}-${office}`;
                    
                    // Check if we've already processed this student-office combination
                    const isNewStudentOffice = !processedStudentOffice.has(studentOfficeKey);
                    
                    // Initialize detailed stats for office if needed
                    if (!officeDetailedStats[office]) {
                        officeDetailedStats[office] = {
                            advisorCaseloads: {}, // Track each advisor's total caseload
                            exclusiveStudents: 0,
                            sharedStudents: 0,
                            totalStudents: 0
                        };
                    }
                    
                    // Only count students and update advisor caseloads if this is a new student-office pair
                    if (isNewStudentOffice) {
                        processedStudentOffice.add(studentOfficeKey);
                        
                        // Track student counts for this office
                        if (isExclusive) {
                            officeDetailedStats[office].exclusiveStudents++;
                        } else {
                            officeDetailedStats[office].sharedStudents++;
                        }
                        officeDetailedStats[office].totalStudents++;
                        
                        // Track advisor caseloads for advisors IN THIS OFFICE
                        const advisorsInOffice = advisorsByOffice[office];
                        advisorsInOffice.forEach(advisorName => {
                            if (!advisorName) return;
                            if (!officeDetailedStats[office].advisorCaseloads[advisorName]) {
                                officeDetailedStats[office].advisorCaseloads[advisorName] = {
                                    exclusive: 0,
                                    shared: 0,
                                    total: 0
                                };
                            }
                            if (isExclusive) {
                                officeDetailedStats[office].advisorCaseloads[advisorName].exclusive++;
                            } else {
                                officeDetailedStats[office].advisorCaseloads[advisorName].shared++;
                            }
                            officeDetailedStats[office].advisorCaseloads[advisorName].total++;
                        });
                    }
                });
                
                // Also maintain the original structure for backward compatibility
                const target = isExclusive ? advisorAssignments.single : advisorAssignments.multiple;
                offices.forEach(office => {
                    if (!office) return;
                    if (!target[office]) target[office] = {};
                    const advisors = advisorsByOffice[office] || [];
                    advisors.forEach(name => {
                        if (!name) return;
                        target[office][name] = (target[office][name] || 0) + 1;
                    });
                });
            });
            // === End new block ===
            
            // === Create student-advisor-office mapping for dynamic count calculations ===
            const studentAdvisorOfficeMap = {};
            
            data.forEach(record => {
                const studentId = record[CONSTANTS.COLUMNS.STUDENT_ID];
                if (!studentId) return;
                
                const staffList = record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '';
                if (!staffList) return;
                
                // Initialize student entry
                if (!studentAdvisorOfficeMap[studentId]) {
                    studentAdvisorOfficeMap[studentId] = {
                        offices: {},
                        isExclusive: true // Will be set to false if multiple offices found
                    };
                }
                
                // Parse all staff entries and organize by office
                const staffEntries = staffList.split(';').map(s => s.trim()).filter(Boolean);
                const studentOffices = new Set();
                
                staffEntries.forEach(entry => {
                    const entryLower = entry.toLowerCase();
                    
                    // Check if this is an advisor role
                    CONSTANTS.ROLES.ADVISOR.forEach(role => {
                        if (entryLower.includes(`(${role})`)) {
                            // Extract advisor name
                            const name = entry.split('(')[0].trim();
                            const normalizedName = name.trim().replace(/\s+/g, ' ');
                            
                            // Determine the office based on the role
                            let office = '';
                            if (role === 'asap advisor') office = 'ASAP';
                            else if (role === 'college discovery counselor') office = 'College Discovery';
                            else if (role === 'student advising services advisor') office = 'Student Advising Services';
                            else if (role === 'international student services advisor') office = 'International Student Services';
                            else if (role === 'careers in engineering advisor') office = 'Careers in Engineering';
                            else if (role === 'cuny 2x tech academy advisor') office = 'CUNY 2X Tech Academy';
                            else if (role === 'veteran services advisor') office = 'Veteran Services';
                            else if (role === 'eci - college now advisor') office = 'ECI - College Now';
                            else if (role === 'eci - energy tech hs advisor') office = 'ECI - Energy Tech HS';
                            else if (role === 'eci - international hs advisor') office = 'ECI - International HS';
                            else if (role === 'eci - middle college hs advisor') office = 'ECI - Middle College HS';
                            else if (role === 'cuny start advisor') office = 'CUNY Start';
                            else if (role === 'math start advisor') office = 'Math Start';
                            
                            if (office) {
                                studentOffices.add(office);
                                
                                // Initialize office entry for this student if needed
                                if (!studentAdvisorOfficeMap[studentId].offices[office]) {
                                    studentAdvisorOfficeMap[studentId].offices[office] = {
                                        advisors: []
                                    };
                                }
                                
                                // Add advisor to office if not already there
                                if (!studentAdvisorOfficeMap[studentId].offices[office].advisors.includes(normalizedName)) {
                                    studentAdvisorOfficeMap[studentId].offices[office].advisors.push(normalizedName);
                                }
                            }
                        }
                    });
                });
                
                // Update exclusive/shared status
                if (studentOffices.size > 1) {
                    studentAdvisorOfficeMap[studentId].isExclusive = false;
                }
            });
            // === End student-advisor-office mapping ===
            
            // === New: flat advisor summary (unique students per advisor, with all offices) ===
            const advisorStudentSummary = {};
            const processedStudentAdvisor = new Set(); // Track which student-advisor pairs we've processed
            
            data.forEach(record => {
                const studentId = record[CONSTANTS.COLUMNS.STUDENT_ID];
                const staffList = (record[CONSTANTS.COLUMNS.ASSIGNED_STAFF] || '');
                if (!studentId || !staffList) return;
                
                // Determine if student has single or multiple programs based on the offices they're enrolled in
                const studentOffices = new Set();
                const entries = staffList.split(';').map(s => s.trim()).filter(Boolean);
                
                entries.forEach(entry => {
                    const entryLower = entry.toLowerCase();
                    CONSTANTS.ROLES.ADVISOR.forEach(role => {
                        if (entryLower.includes(`(${role})`)) {
                            // Determine office from role
                            let office = '';
                            if (role === 'asap advisor') office = 'ASAP';
                            else if (role === 'college discovery counselor') office = 'College Discovery';
                            else if (role === 'student advising services advisor') office = 'Student Advising Services';
                            else if (role === 'international student services advisor') office = 'International Student Services';
                            else if (role === 'careers in engineering advisor') office = 'Careers in Engineering';
                            else if (role === 'cuny 2x tech academy advisor') office = 'CUNY 2X Tech Academy';
                            else if (role === 'veteran services advisor') office = 'Veteran Services';
                            else if (role === 'eci - college now advisor') office = 'ECI - College Now';
                            else if (role === 'eci - energy tech hs advisor') office = 'ECI - Energy Tech HS';
                            else if (role === 'eci - international hs advisor') office = 'ECI - International HS';
                            else if (role === 'eci - middle college hs advisor') office = 'ECI - Middle College HS';
                            else if (role === 'cuny start advisor') office = 'CUNY Start';
                            else if (role === 'math start advisor') office = 'Math Start';
                            
                            if (office) studentOffices.add(office);
                        }
                    });
                });
                
                const isExclusive = (studentOffices.size === 1);
                
                // Process each advisor entry
                entries.forEach(entry => {
                    const entryLower = entry.toLowerCase();
                    const isAdvisorRole = CONSTANTS.ROLES.ADVISOR.some(role => entryLower.includes(`(${role})`));
                    if (!isAdvisorRole) return;
                    
                    const rawName = entry.split('(')[0].trim();
                    const name = normalizeAdvisorName(rawName); // Normalize the name
                    
                    // Create unique key for student-advisor pair
                    const studentAdvisorKey = `${studentId}-${name}`;
                    
                    // Only process if this is a new student-advisor pair
                    if (!processedStudentAdvisor.has(studentAdvisorKey)) {
                        processedStudentAdvisor.add(studentAdvisorKey);
                        
                        // Determine the advisor's office based on their ROLE
                        const m = entry.match(/\((.*?)\)/);
                        let office = '';
                        if (m) {
                            const role = m[1].toLowerCase();
                            if (role === 'asap advisor') office = 'ASAP';
                            else if (role === 'college discovery counselor') office = 'College Discovery';
                            else if (role === 'student advising services advisor') office = 'Student Advising Services';
                            else if (role === 'international student services advisor') office = 'International Student Services';
                            else if (role === 'careers in engineering advisor') office = 'Careers in Engineering';
                            else if (role === 'cuny 2x tech academy advisor') office = 'CUNY 2X Tech Academy';
                            else if (role === 'veteran services advisor') office = 'Veteran Services';
                            else if (role === 'eci - college now advisor') office = 'ECI - College Now';
                            else if (role === 'eci - energy tech hs advisor') office = 'ECI - Energy Tech HS';
                            else if (role === 'eci - international hs advisor') office = 'ECI - International HS';
                            else if (role === 'eci - middle college hs advisor') office = 'ECI - Middle College HS';
                            else if (role === 'cuny start advisor') office = 'CUNY Start';
                            else if (role === 'math start advisor') office = 'Math Start';
                        }
                        
                        if (!advisorStudentSummary[name]) {
                            advisorStudentSummary[name] = { 
                                students: new Set(), 
                                offices: new Set(),
                                exclusiveStudents: new Set(),
                                sharedStudents: new Set()
                            };
                        }
                        advisorStudentSummary[name].students.add(String(studentId));
                        if (office) advisorStudentSummary[name].offices.add(office);
                        
                        // Track exclusive vs shared
                        if (isExclusive) {
                            advisorStudentSummary[name].exclusiveStudents.add(String(studentId));
                        } else {
                            advisorStudentSummary[name].sharedStudents.add(String(studentId));
                        }
                    }
                });
            });
            const advisorAssignmentsFlat = Object.entries(advisorStudentSummary).map(([advisor, obj]) => ({
                advisor,
                offices: Array.from(obj.offices).sort().join('; '),
                exclusive: obj.exclusiveStudents.size,
                shared: obj.sharedStudents.size,
                count: obj.students.size
            })).sort((a,b) => {
                // sort by offices then advisor (alphabetical)
                const ao = (a.offices||'').localeCompare(b.offices||'');
                return ao !== 0 ? ao : a.advisor.localeCompare(b.advisor);
            });
            // === End: flat advisor summary ===

analytics.advising = {
                singleOffices: sortedOffices.filter(([office]) => !office.includes(';')),
                multipleOffices: sortedOffices.filter(([office]) => office.includes(';')),
                singleOfficeBreakdown,  // Add the breakdown for single office assignments
                noOfficeCount,
                noOfficeBreakdown,
                dataQuality: advisorDataQuality
            ,
                advisorAssignmentsFlat
,
                advisorAssignments,
                officeDetailedStats,
                studentAdvisorOfficeMap  // Add the mapping for dynamic recalculation
};

            analytics.academic = calculateAcademicDepartmentAnalytics(data);

            if (appState.data.faculty) {
                analytics.faculty = calculateFacultyAnalytics(data);
            }

            if (appState.data.peer) {
                analytics.peer = calculatePeerAnalytics(data);
            }

            analytics.category = calculateCategoryAnalytics(data);

            return analytics;
        }

        function calculateAcademicDepartmentAnalytics(data) {
            const departmentCounts = {};
            let studentsWithNoMajor = 0;
            let studentsWithMajorButNoDept = 0;
            
            data.forEach(record => {
                const major = record[CONSTANTS.COLUMNS.Major];
                const department = record[CONSTANTS.COLUMNS.STUDENT_DEPT];
                
                if (!major || major.trim() === '') {
                    studentsWithNoMajor++;
                } else if (!department || department.trim() === '') {
                    studentsWithMajorButNoDept++;
                } else {
                    if (!departmentCounts[department]) {
                        departmentCounts[department] = 0;
                    }
                    departmentCounts[department]++;
                }
            });
            
            return {
                departmentCounts,
                studentsWithNoMajor,
                studentsWithMajorButNoDept,
                totalStudents: data.length
            };
        }

        function calculateFacultyAnalytics(data) {
            const facultyInCaseload = new Set();
            const facultyDeptMapFromCaseload = {};
            
            data.forEach(record => {
                const faculty = record[CONSTANTS.COLUMNS.FACULTY_MENTOR];
                const facultyDept = record['Faculty Academic Department'];
                
                if (faculty?.trim()) {
                    faculty.split(';').forEach((name, index) => {
                        const trimmedName = name.trim();
                        if (trimmedName) {
                            facultyInCaseload.add(trimmedName);
                            if (facultyDept) {
                                const depts = facultyDept.split(';').map(d => d.trim());
                                const dept = depts[index] || depts[0] || 'Unknown Department';
                                facultyDeptMapFromCaseload[trimmedName] = dept;
                            }
                        }
                    });
                }
            });
            
            const facultyInFile = new Set();
            const fileFacultyDeptMap = {};
            const config = CONSTANTS.LOOKUP_CONFIGS.faculty;
            const lookupMap = createLookupMap(appState.data.faculty, config);
            
            Object.entries(lookupMap).forEach(([name, entry]) => {
                facultyInFile.add(name);
                fileFacultyDeptMap[name] = entry.dept || 'Unknown Department';
            });
            
            const facultyDataQuality = {
                facultyInCaseloadNotInFile: [...facultyInCaseload].filter(faculty => !facultyInFile.has(faculty)).sort(),
                facultyInFileNotInCaseload: [...facultyInFile].filter(faculty => !facultyInCaseload.has(faculty)).sort(),
                totalFacultyInFile: facultyInFile.size,
                totalFacultyInCaseload: facultyInCaseload.size,
                facultyDepartmentMap: facultyDeptMapFromCaseload,
                fileFacultyDepartmentMap: fileFacultyDeptMap
            };
            
            // Calculate Faculty-Student Department Mismatch Analysis
            const departmentMismatchAnalysis = calculateFacultyStudentDepartmentMismatches(data);
            
            const facultyAnalytics = calculateStaffAnalytics(data, CONSTANTS.COLUMNS.FACULTY_MENTOR, 'Faculty Academic Department');
            facultyAnalytics.dataQuality = facultyDataQuality;
            facultyAnalytics.departmentMismatchAnalysis = departmentMismatchAnalysis;
            
            // Compute nested Faculty Academic Department_sub breakdowns within each Faculty Academic Department
            (function buildFacultyDeptSubBreakouts(){
                const nested = {}; // { Dept -> { Sub -> { staff:Set, students:Int } } }
                data.forEach(record => {
                    const faculty = record[CONSTANTS.COLUMNS.FACULTY_MENTOR];
                    const dept = record['Faculty Academic Department'];
                    const deptSub = record['Faculty Academic Department_sub'];
                    if (faculty?.trim()) {
                        const names = faculty.split(';').map(s=>s.trim());
                        const depts = (dept ? dept.split(';').map(s=>s.trim()) : ['Unknown']);
                        const subs  = (deptSub ? deptSub.split(';').map(s=>s.trim()) : ['Unknown']);
                        names.forEach((name, i) => {
                            const d = depts[i] || depts[0] || 'Unknown';
                            const s = subs[i]  || subs[0]  || 'Unknown';
                            if (!nested[d]) nested[d] = {};
                            if (!nested[d][s]) nested[d][s] = { staff: new Set(), students: 0 };
                            if (name) nested[d][s].staff.add(name);
                            nested[d][s].students++;
                        });
                    }
                });
                // Convert Sets to counts and compute avgs
                const out = {};
                Object.entries(nested).forEach(([dept, subMap]) => {
                    out[dept] = {};
                    Object.entries(subMap).forEach(([sub, stats]) => {
                        const staffCount = stats.staff.size;
                        out[dept][sub] = {
                            staff: staffCount,
                            students: stats.students,
                            avg: staffCount > 0 ? (stats.students / staffCount).toFixed(1) : '0.0'
                        };
                    });
                });
                facultyAnalytics.departmentSubStats = out;
            })();

            return facultyAnalytics;
        }

        function calculateFacultyStudentDepartmentMismatches(data) {
            const mismatches = {};
            let totalMismatches = 0;
            
            data.forEach(record => {
                const facultyMentor = record[CONSTANTS.COLUMNS.FACULTY_MENTOR];
                const facultyDeptSub = record['Faculty Academic Department_sub'];
                const studentDeptSub = record[CONSTANTS.COLUMNS.STUDENT_DEPT_SUB];
                
                // Only analyze records that have both faculty mentor and department sub information
                if (facultyMentor?.trim() && facultyDeptSub?.trim() && studentDeptSub?.trim()) {
                    const facultyNames = facultyMentor.split(';').map(name => name.trim());
                    const facultyDepts = facultyDeptSub.split(';').map(dept => dept.trim());
                    
                    facultyNames.forEach((facultyName, index) => {
                        const facultyDept = facultyDepts[index] || facultyDepts[0];
                        
                        // Check if faculty department_sub matches student department_sub
                        if (facultyDept !== studentDeptSub) {
                            const mismatchKey = `${facultyDept} ‚Üí ${studentDeptSub}`;
                            mismatches[mismatchKey] = (mismatches[mismatchKey] || 0) + 1;
                            totalMismatches++;
                        }
                    });
                }
            });
            
            return {
                mismatches,
                totalMismatches
            };
        }

        function calculateStaffAnalytics(data, staffColumn, deptColumn) {
            const staffStats = {};
            const allStaffGlobal = new Set(); // Track unique staff across all departments
            let totalStudentsWithStaff = 0;
            
            // Track students with multiple mentors
            const multiMentorStats = {
                sameDept: [],      // Students with 2+ mentors in same department
                diffDept: [],      // Students with mentors in different departments
                sameDeptByDept: {} // Breakdown by department for same-dept multiples
            };
            
            data.forEach(record => {
                const staff = record[staffColumn];
                const dept = record[deptColumn];
                const studentId = record[CONSTANTS.COLUMNS.STUDENT_ID];
                
                if (staff?.trim()) {
                    totalStudentsWithStaff++;
                    const staffNames = staff.split(';').map(name => name.trim()).filter(Boolean);
                    const depts = dept ? dept.split(';').map(d => d.trim()) : ['Unknown'];
                    
                    // Check for multiple mentors
                    if (staffNames.length > 1) {
                        const uniqueDepts = [...new Set(depts)];
                        
                        if (uniqueDepts.length === 1) {
                            // All mentors in the same department
                            multiMentorStats.sameDept.push({
                                studentId: studentId,
                                mentors: staffNames,
                                department: uniqueDepts[0]
                            });
                            // Track by department
                            const deptKey = uniqueDepts[0];
                            if (!multiMentorStats.sameDeptByDept[deptKey]) {
                                multiMentorStats.sameDeptByDept[deptKey] = 0;
                            }
                            multiMentorStats.sameDeptByDept[deptKey]++;
                        } else {
                            // Mentors in different departments
                            multiMentorStats.diffDept.push({
                                studentId: studentId,
                                mentors: staffNames,
                                departments: depts
                            });
                        }
                    }
                    
                    staffNames.forEach((name, index) => {
                        const staffDept = depts[index] || depts[0] || 'Unknown';
                        
                        if (!staffStats[staffDept]) {
                            staffStats[staffDept] = { staff: new Set(), students: new Set() };
                        }
                        
                        staffStats[staffDept].staff.add(name);
                        staffStats[staffDept].students.add(studentId); // Use Set to avoid double-counting
                        allStaffGlobal.add(name); // Track globally for unique total
                    });
                }
            });
            
            const departmentStats = {};
            Object.entries(staffStats).forEach(([dept, data]) => {
                departmentStats[dept] = {
                    staff: data.staff.size,
                    students: data.students.size, // Now using Set size
                    avg: data.staff.size > 0 ? (data.students.size / data.staff.size).toFixed(1) : '0.0'
                };
            });
            
            const totalStaff = allStaffGlobal.size; // Unique count across all departments
            const avgStudentsPerStaff = totalStaff > 0 ? (totalStudentsWithStaff / totalStaff).toFixed(1) : '0.0';
            
            return {
                totalStaff,
                totalStudents: totalStudentsWithStaff,
                avgStudentsPerStaff,
                departmentStats,
                multiMentorStats // Include multiple mentor tracking
            };
        }

        function calculatePeerAnalytics(data) {
            const peerStats = {};
            const departmentStats = {};
            const peerAssignmentStats = {};
            let totalStudentsWithPeers = 0;
            
            const peerDeptMap = {};
            const peersInFile = new Set();
            
            if (appState.data.peer?.length > 1) {
                const config = CONSTANTS.LOOKUP_CONFIGS.peer;
                const lookupMap = createLookupMap(appState.data.peer, config);
                Object.entries(lookupMap).forEach(([name, entry]) => {
                    peersInFile.add(name);
                    if (entry.dept) peerDeptMap[name] = entry.dept;
                });
            }
            
            const peersInCaseload = new Set();
            
            data.forEach(record => {
                const studentDept = record[CONSTANTS.COLUMNS.STUDENT_DEPT] || 'Unknown';
                const peerAdvisor = record[CONSTANTS.COLUMNS.PEER_ADVISOR];
                
                if (!departmentStats[studentDept]) {
                    departmentStats[studentDept] = { totalStudents: 0, withPeers: 0 };
                }
                departmentStats[studentDept].totalStudents++;
                
                if (peerAdvisor?.trim()) {
                    totalStudentsWithPeers++;
                    departmentStats[studentDept].withPeers++;
                    
                    const peerNames = peerAdvisor.split(';').map(name => name.trim());
                    peerNames.forEach(peer => {
                        peersInCaseload.add(peer);
                        peerStats[peer] = (peerStats[peer] || 0) + 1;
                        
                        const peerDept = peerDeptMap[peer] || 'Unknown';
                        
                        if (!peerAssignmentStats[peerDept]) {
                            peerAssignmentStats[peerDept] = { peers: {} };
                        }
                        
                        peerAssignmentStats[peerDept].peers[peer] = (peerAssignmentStats[peerDept].peers[peer] || 0) + 1;
                    });
                }
            });
            
            const peersInCaseloadNotInFile = [...peersInCaseload].filter(peer => !peersInFile.has(peer)).sort();
            const peersInFileNotInCaseload = [...peersInFile].filter(peer => !peersInCaseload.has(peer)).sort();
            
            return {
                totalStudentsWithPeers,
                totalUniquePeers: Object.keys(peerStats).length,
                peerAssignmentPercentage: data.length > 0 ? ((totalStudentsWithPeers / data.length) * 100).toFixed(1) : '0.0',
                departmentStats,
                peerAssignmentStats,
                dataQuality: {
                    peersInCaseloadNotInFile,
                    peersInFileNotInCaseload,
                    totalPeersInFile: peersInFile.size,
                    totalPeersInCaseload: peersInCaseload.size
                }
            };
        }

        function calculateCategoryAnalytics(data) {
            const categoryStats = {};
            
            data.forEach(record => {
                const category = record[CONSTANTS.COLUMNS.CATEGORY] || '';
                if (!category.trim()) return;
                
                const categories = category.split(',').map(cat => cat.trim()).filter(cat => cat);
                
                categories.forEach(cat => {
                    if (cat.startsWith('Major:')) return;
                    
                    if (!categoryStats[cat]) {
                        categoryStats[cat] = {
                            count: 0,
                            selected: true
                        };
                    }
                    categoryStats[cat].count++;
                });
            });
            
            const featuredPrefixes = [];
            
            
// ---- Term selector state for Category Manager ----
window.TERM_STATE = window.TERM_STATE || {
  year: new Date().getFullYear(),
  termCode: (new Date().getMonth() >= 0 && new Date().getMonth() <= 4) ? 'SP' : 'FA' // Jan-May -> SP, else FA
};

function termFull(year, termCode) {
  return termCode === 'FA' ? `${year} Fall Term` : `${year} Spring Term`;
}

function buildFeaturedExact(year, termCode) {
  const tf = termFull(year, termCode);
  // Order matters. New Student items are placed AFTER SG:RADM-Readmit per user request.
  return [
    'SG:ASAP-Official ASAP Student',
    'SG:ASP2-Applied to ASAP',
    'SG:ASP3-Accepts ASAP Invitation',
    'SG:ASP4-Denied/Declined ASAP',
    'SG:CD-College Discovery Student',
    'SG:ISS-International Student Service',
    'SG:CLIP-CLIP Student',
    'SG:CST1-Required CS students CSE95/3+',
    'SG:CST3-With CST indicator',
    'SG:MST1-Req MS Students MAT95/96',
    'SG:MST3-With MST Indicator',
    'SG:CNOW-College Now Student',
    'SG:ECI-Early College Initiative',
    'SG:FRSH-Entering Freshman',
    'SG:TRNS-Entering Transfer Student',
    'SG:RADM-Readmit',
    // New Student categories come after RADM
    `New Student: ${year} ${termCode} - First-Year`,
    `New Student: ${year} ${termCode} - Transfer`,
    `Enrolled in Session1 - ${tf}`,
    `Enrolled in Session2 - ${tf}`,
    `Enrolled in Intent to Grad - ${tf}`,
    `Enrolled in any Clinical Course - ${tf}`,
    `Only Enrolled in Intent to Grad ${year} ${termCode}`
  ];
}
const featuredExact = buildFeaturedExact(TERM_STATE.year, TERM_STATE.termCode);
            
            const isValidEnrolledCategory = (category) => { return false; };
            
            const featuredCategories = [];
            const otherCategories = [];
            
            Object.entries(categoryStats).forEach(([category, stats]) => {
                let isFeatured = false;
                
                if (featuredExact.includes(category)) {
                    isFeatured = true;
                } else if (isValidEnrolledCategory(category)) {
                    isFeatured = true;
                } else {
                    for (const prefix of featuredPrefixes) {
                        if (category.startsWith(prefix)) {
                            isFeatured = true;
                            break;
                        }
                    }
                }
                
                if (isFeatured) {
                    featuredCategories.push([category, stats]);
                } else {
                    otherCategories.push([category, stats]);
                }
            });
            
            featuredCategories.sort(([a, statsA], [b, statsB]) => {
                const aExactIndex = featuredExact.indexOf(a);
                const bExactIndex = featuredExact.indexOf(b);
                const aIsEnrolled = isValidEnrolledCategory(a);
                const bIsEnrolled = isValidEnrolledCategory(b);
                
                if (aExactIndex !== -1 && bExactIndex !== -1) {
                    return aExactIndex - bExactIndex;
                }
                if (aExactIndex !== -1 && bExactIndex === -1) return -1;
                if (aExactIndex === -1 && bExactIndex !== -1) return 1;
                if (aIsEnrolled && !bIsEnrolled) return -1;
                if (!aIsEnrolled && bIsEnrolled) return 1;
                if (aIsEnrolled && bIsEnrolled) {
                    return a.localeCompare(b);
                }
                return statsB.count - statsA.count;
            });
            
            otherCategories.sort(([a, statsA], [b, statsB]) => {
                if (statsB.count !== statsA.count) {
                    return statsB.count - statsA.count;
                }
                return a.localeCompare(b);
            });
            
            return {
                totalCategories: featuredCategories.length + otherCategories.length,
                totalStudents: data.length,
                featuredCategories,
                otherCategories
            };
        }

        // DASHBOARD GENERATION
        function showDashboard() {
            try {
                const analytics = calculateAnalytics();
                const data = appState.processedData;
                
                let dashboardHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="border-bottom: 2px solid #dee2e6; margin-bottom: 20px;">
                            <button id="advisingTab" class="tab-button active" onclick="showTab('advising')" style="padding: 10px 20px; margin-right: 10px; border: none; background: none; border-bottom: 3px solid #007bff; font-weight: bold; cursor: pointer; color: #333;">Advising Office</button>
                            <button id="academicTab" class="tab-button" onclick="showTab('academic')" style="padding: 10px 20px; margin-right: 10px; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; color: #666;">Academic Departments</button>
                            ${appState.data.faculty ? '<button id="facultyTab" class="tab-button" onclick="showTab(\'faculty\')" style="padding: 10px 20px; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; color: #666;">Faculty Mentors</button>' : ''}
                            ${appState.data.peer ? '<button id="peerTab" class="tab-button" onclick="showTab(\'peer\')" style="padding: 10px 20px; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; color: #666;">Peer Advisors</button>' : ''}
                            <button id="categoryTab" class="tab-button" onclick="showTab('category')" style="padding: 10px 20px; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; color: #666;">Category Manager</button>
                        </div>
                        
                        <div id="advisingContent" class="tab-content">
                            ${generateAdvisingDashboard(analytics.advising, data.length)}
                        </div>
                        
                        <div id="academicContent" class="tab-content" style="display: none;">
                            ${generateAcademicDepartmentDashboard(analytics.academic, data.length)}
                        </div>
                        
                        ${appState.data.faculty ? `<div id="facultyContent" class="tab-content" style="display: none;">
                            ${generateFacultyDashboard(analytics.faculty)}
                        </div>` : ''}
                        
                        ${appState.data.peer ? `<div id="peerContent" class="tab-content" style="display: none;">
                            ${generatePeerDashboard(analytics.peer, data.length)}
                        </div>` : ''}
                        
                        <div id="categoryContent" class="tab-content" style="display: none;">
                            ${generateCategoryManagerDashboard(analytics.category)}
                        </div>
                    </div>
                `;
                
                document.getElementById('resultsArea').innerHTML = `
                    <div style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #333;">Processing Complete</h3>
                        <p style="color: #666;">Successfully processed ${data.length} records.</p>
                        ${dashboardHTML}
                        <div style="margin-top: 30px; padding: 20px; background-color: #e8f4f8; border: 1px solid #b8dae5; border-radius: 8px;">
                            <h4 style="margin-top: 0; color: #0c5460;">Export Processed Data</h4>
                            <p style="color: #0c5460;">Click to download the processed CSV:</p>
                            <button id="copyBtn" onclick="exportProcessedData()" style="background-color: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Download CSV</button>

<div class="progress-container" id="copyProgressContainer" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; display: none;">
    <div class="progress-text" id="copyProgressText">Preparing CSV data...</div>
    <div class="progress-bar" style="width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
        <div class="progress-fill" id="copyProgressFill" style="height: 100%; background: linear-gradient(90deg, #17a2b8, #138496); border-radius: 10px; transition: width 0.3s ease; width: 0%;"></div>
    </div>
    <div class="progress-details" id="copyProgressDetails" style="font-size: 12px; color: #6c757d; text-align: center;">Initializing...</div>
</div>
                        </div>
                    </div>
                `;
                
                utils.showStatus('Dashboard generated successfully!', 'success');
                
                // Initialize selected categories
                if (analytics.category && (analytics.category.featuredCategories || analytics.category.otherCategories)) {
                    selectedCategories = {};
                    if (analytics.category.featuredCategories) {
                        analytics.category.featuredCategories.forEach(([category, stats]) => {
                            selectedCategories[category] = stats.selected;
                        });
                    }
                    if (analytics.category.otherCategories) {
                        analytics.category.otherCategories.forEach(([category, stats]) => {
                            selectedCategories[category] = stats.selected;
                        });
                    }
                }
                
            } catch (error) {
                utils.showStatus('Error creating dashboard: ' + error.message, 'error');
            }
        }

        
function generateAdvisingDashboard(analytics, totalRecords) {
    if (!analytics) return '<p>No advising data available.</p>';
    
    const { singleOffices, multipleOffices, noOfficeCount, noOfficeBreakdown, dataQuality, advisorAssignmentsFlat } = analytics;

    // Pre-calc: sums & alphabetized lists
    const singleOfficeTotal = singleOffices.reduce((sum, [, c]) => sum + c, 0);
    const multipleOfficeTotal = multipleOffices.reduce((sum, [, c]) => sum + c, 0);
    const singleOfficesAlpha = [...singleOffices].sort(([a],[b]) => a.localeCompare(b));
    const multipleOfficesAlpha = [...multipleOffices].sort(([a],[b]) => a.localeCompare(b));

    let html = '<h4 style="color: #333; margin-bottom: 15px;">üìä Advising Office Dashboard</h4>';

    // Engaging summary cards
    html += `
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px;">
      <div style="flex:1 1 220px; background:#e7f3ff; border:1px solid #b8daf5; border-radius:8px; padding:14px;">
        <div style="font-size:12px; color:#0b4f8a; font-weight:600;">Total Students</div>
        <div style="font-size:24px; font-weight:800; color:#0b4f8a;">${totalRecords}</div>
      </div>
      <div style="flex:1 1 220px; background:#eafaf1; border:1px solid #bfe8d0; border-radius:8px; padding:14px;">
        <div style="font-size:12px; color:#0f6b3a; font-weight:600;">Single Office</div>
        <div style="font-size:24px; font-weight:800; color:#0f6b3a;">${singleOfficeTotal}</div>
        <div style="font-size:12px; color:#0f6b3a;">${((singleOfficeTotal/totalRecords)*100).toFixed(1)}%</div>
        ${analytics.singleOfficeBreakdown ? `
        <div style="font-size:10px; color:#0f6b3a; margin-top:4px; border-top:1px solid #bfe8d0; padding-top:4px;">
          Single Advisor: ${analytics.singleOfficeBreakdown.singleAdvisor}<br>
          Multiple Advisors: ${analytics.singleOfficeBreakdown.multipleAdvisors}
        </div>` : ''}
      </div>
      <div style="flex:1 1 220px; background:#fff7e6; border:1px solid #ffe0a6; border-radius:8px; padding:14px;">
        <div style="font-size:12px; color:#8a5b0b; font-weight:600;">Multiple Offices</div>
        <div style="font-size:24px; font-weight:800; color:#8a5b0b;">${multipleOfficeTotal}</div>
        <div style="font-size:12px; color:#8a5b0b;">${((multipleOfficeTotal/totalRecords)*100).toFixed(1)}%</div>
      </div>
      <div style="flex:1 1 220px; background:#fdecee; border:1px solid #f5c2c7; border-radius:8px; padding:14px;">
        <div style="font-size:12px; color:#7e1e2a; font-weight:600;">No Office</div>
        <div style="font-size:24px; font-weight:800; color:#7e1e2a;">${noOfficeCount}</div>
        <div style="font-size:12px; color:#7e1e2a;">${((noOfficeCount/totalRecords)*100).toFixed(1)}%</div>
      </div>
    </div>`;

    // Optional mini-bar viz (top 5 single offices)
    if (singleOfficesAlpha.length > 0) {
        const top = singleOfficesAlpha.slice(0, 5);
        const max = Math.max(...top.map(([,c]) => c));
        html += '<div style="margin-bottom:14px;">';
        html += '<div style="font-weight:700; color:#0b4f8a; margin-bottom:6px;">Top Single Offices</div>';
        top.forEach(([name, count]) => {
            const pct = max ? (count / max) * 100 : 0;
            html += `
              <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
                <div style="min-width:220px; font-size:12px;">${name}</div>
                <div style="flex:1; background:#eef5ff; height:10px; border-radius:6px; overflow:hidden;">
                  <div style="width:${pct}%; height:100%; background:linear-gradient(90deg,#007bff,#0056b3);"></div>
                </div>
                <div style="min-width:60px; text-align:right; font-size:12px; font-weight:700;">${count}</div>
              </div>`;
        });
        html += '</div>';
    }

    // Data Quality Report for Advisors
    if (dataQuality) {
        html += '<h5 style="color: #dc3545; margin-bottom: 15px;">üîç Advisor Data Quality Report</h5>';
        
        const hasIssues = dataQuality.advisorsInCaseloadNotInFile.length > 0 || dataQuality.advisorsInFileNotInCaseload.length > 0;
        
        if (hasIssues) {
            html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">';
            html += '<p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">‚ö†Ô∏è Advisor Data Mismatches Found:</p>';
            
            if (dataQuality.advisorsInCaseloadNotInFile.length > 0) {
                html += `<p style="margin: 5px 0; color: #721c24;"><strong>Professional Advisors in Caseload but NOT in Advisor Staff File (${dataQuality.advisorsInCaseloadNotInFile.length}):</strong></p>`;
                html += '<ul style="margin: 5px 0 15px 20px; color: #721c24;">';
                dataQuality.advisorsInCaseloadNotInFile.forEach(advisor => { html += `<li>${advisor}</li>`; });
                html += '</ul>';
            }
            
            if (dataQuality.advisorsInFileNotInCaseload.length > 0) {
                html += `<p style="margin: 5px 0; color: #0c5460;"><strong>Advisors in Staff File but NOT in Caseload (${dataQuality.advisorsInFileNotInCaseload.length}):</strong></p>`;
                html += '<ul style="margin: 5px 0 15px 20px; color: #0c5460;">';
                dataQuality.advisorsInFileNotInCaseload.forEach(advisor => { html += `<li>${advisor}</li>`; });
                html += '</ul>';
            }
            
            html += `<p style="margin: 10px 0 0 0; font-size: 12px; color: #856404;"><em>Summary: ${dataQuality.totalAdvisorsInCaseload} unique advisors in caseload, ${dataQuality.totalAdvisorsInFile} in staff file</em></p>`;
            html += '</div>';
        } else {
            html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px;">';
            html += '<p style="margin: 0; font-weight: bold; color: #155724;">‚úÖ All professional advisors match between files!</p>';
            html += `<p style="margin: 5px 0 0 0; font-size: 12px; color: #155724;"><em>${dataQuality.totalAdvisorsInCaseload} unique advisors found in both files</em></p>`;
            html += '</div>';
        }
    }
    
    // TABLE 1: Students with Office Assignments (Single + Multiple combined)
    const studentsWithOffice = singleOfficeTotal + multipleOfficeTotal;
    
    if (studentsWithOffice > 0) {
        html += '<h5 style="color:#333;margin:20px 0 10px;">Students with Office Assignments</h5>';
        const headers = [
            { title: 'Advising Office', align: 'left' },
            { title: 'Student Count', align: 'right' },
            { title: 'Percentage', align: 'right' }
        ];
        const rows = [];

        // Single Office section
        if (singleOfficesAlpha.length > 0) {
            rows.push({ cells: [{ content: 'Single Office Assignments', style: 'background-color: #f8f9fa; font-weight: bold;', colspan: 3 }] });
            
            // Add breakdown for single vs multiple advisors within single office
            if (analytics.singleOfficeBreakdown) {
                if (analytics.singleOfficeBreakdown.singleAdvisor > 0) {
                    const pct = ((analytics.singleOfficeBreakdown.singleAdvisor / studentsWithOffice) * 100).toFixed(1);
                    rows.push({
                        cells: [
                            { content: '‚îú‚îÄ‚îÄ Single Advisor', style: 'padding-left: 30px; font-style: italic; color: #495057;' },
                            { content: analytics.singleOfficeBreakdown.singleAdvisor, style: 'text-align: right; font-style: italic; color: #495057;' },
                            { content: `${pct}%`, style: 'text-align: right; font-style: italic; color: #495057;' }
                        ]
                    });
                }
                
                if (analytics.singleOfficeBreakdown.multipleAdvisors > 0) {
                    const pct = ((analytics.singleOfficeBreakdown.multipleAdvisors / studentsWithOffice) * 100).toFixed(1);
                    rows.push({
                        cells: [
                            { content: '‚îî‚îÄ‚îÄ Multiple Advisors (same office)', style: 'padding-left: 30px; font-style: italic; color: #495057;' },
                            { content: analytics.singleOfficeBreakdown.multipleAdvisors, style: 'text-align: right; font-style: italic; color: #495057;' },
                            { content: `${pct}%`, style: 'text-align: right; font-style: italic; color: #495057;' }
                        ]
                    });
                    
                    // Show breakdown by specific office
                    if (analytics.singleOfficeBreakdown.multipleAdvisorsByOffice) {
                        const offices = Object.entries(analytics.singleOfficeBreakdown.multipleAdvisorsByOffice)
                            .sort((a, b) => b[1] - a[1]); // Sort by count descending
                        
                        offices.forEach(([office, count], index) => {
                            const isLast = index === offices.length - 1;
                            const prefix = isLast ? '        ‚îî‚îÄ‚îÄ' : '        ‚îú‚îÄ‚îÄ';
                            const officePct = ((count / analytics.singleOfficeBreakdown.multipleAdvisors) * 100).toFixed(1);
                            rows.push({
                                cells: [
                                    { content: `${prefix} ${office}`, style: 'padding-left: 60px; font-size: 12px; color: #6c757d;' },
                                    { content: count, style: 'text-align: right; font-size: 12px; color: #6c757d;' },
                                    { content: `${officePct}% of multi`, style: 'text-align: right; font-size: 12px; color: #6c757d;' }
                                ]
                            });
                        });
                    }
                }
                
                // Add a separator row for better visual clarity
                rows.push({
                    cells: [
                        { content: '', style: 'border: none; height: 8px;', colspan: 3 }
                    ]
                });
            }
            
            // Office-by-office breakdown
            singleOfficesAlpha.forEach(([office, count]) => {
                const percentage = ((count / studentsWithOffice) * 100).toFixed(1);
                rows.push({
                    cells: [
                        { content: office },
                        { content: count, style: 'text-align: right;' },
                        { content: `${percentage}%`, style: 'text-align: right;' }
                    ]
                });
            });
            // Subtotal row
            const singlePct = ((singleOfficeTotal / studentsWithOffice) * 100).toFixed(1);
            rows.push({
                style: 'background-color: #f8f9fa;',
                cells: [
                    { content: 'Subtotal ‚Äî Single Office', style: 'font-weight:bold;' },
                    { content: singleOfficeTotal, style: 'text-align:right; font-weight:bold;' },
                    { content: `${singlePct}%`, style: 'text-align:right; font-weight:bold;' }
                ]
            });
        }

        // Multiple Office section
        if (multipleOfficesAlpha.length > 0) {
            rows.push({ cells: [{ content: 'Multiple Office Assignments', style: 'background-color: #f8f9fa; font-weight: bold;', colspan: 3 }] });
            multipleOfficesAlpha.forEach(([office, count]) => {
                const percentage = ((count / studentsWithOffice) * 100).toFixed(1);
                rows.push({
                    cells: [
                        { content: office },
                        { content: count, style: 'text-align: right;' },
                        { content: `${percentage}%`, style: 'text-align: right;' }
                    ]
                });
            });
            // Subtotal row
            const multiplePct = ((multipleOfficeTotal / studentsWithOffice) * 100).toFixed(1);
            rows.push({
                style: 'background-color: #f8f9fa;',
                cells: [
                    { content: 'Subtotal ‚Äî Multiple Offices', style: 'font-weight:bold;' },
                    { content: multipleOfficeTotal, style: 'text-align:right; font-weight:bold;' },
                    { content: `${multiplePct}%`, style: 'text-align:right; font-weight:bold;' }
                ]
            });
        }

        html += utils.createTable(headers, rows, {
            grandTotal: {
                color: '#333',
                cells: [
                    { content: 'GRAND TOTAL ‚Äî With Office' },
                    { content: studentsWithOffice, align: 'right' },
                    { content: '100.0%', align: 'right' }
                ]
            }
        });
    }

    // TABLE 2: Students with No Office Assignment
    if (noOfficeCount > 0) {
        html += '<h5 style="color:#333;margin:30px 0 10px;">Students with No Office Assignment</h5>';
        const headers = [
            { title: 'Category', align: 'left' },
            { title: 'Student Count', align: 'right' },
            { title: 'Percentage', align: 'right' }
        ];
        const rows = [];

        const addBreakdownRow = (label, value) => {
            if (value > 0) {
                const p = ((value / noOfficeCount) * 100).toFixed(1);
                rows.push({
                    cells: [
                        { content: label },
                        { content: value, style: 'text-align: right;' },
                        { content: `${p}%`, style: 'text-align: right;' }
                    ]
                });
            }
        };

        addBreakdownRow('Non-Degree Students', noOfficeBreakdown.nonDegree);
        addBreakdownRow('Entering Freshman (SG:FRSH)', noOfficeBreakdown.enteringFreshman);
        addBreakdownRow('Entering Transfer (SG:TRNS)', noOfficeBreakdown.enteringTransfer);
        addBreakdownRow('Readmit Students (SG:RADM)', noOfficeBreakdown.readmit);
        addBreakdownRow('College Now Students (SG:CNOW)', noOfficeBreakdown.collegeNow);
        addBreakdownRow('Potential SEEK/CD Students (SG:SCD1)', noOfficeBreakdown.potentialSeekCD);
        addBreakdownRow('Conditional SEEK/CD Students (SG:SCD2)', noOfficeBreakdown.conditionalSeekCD);
        addBreakdownRow('Early College Initiative Students (SG:ECI)', noOfficeBreakdown.earlyCollege);
        addBreakdownRow('International Students (SG:ISS)', noOfficeBreakdown.internationalStudent);
        addBreakdownRow('ASAP Accepts Students (SG:ASP3)', noOfficeBreakdown.asapAccepts);

        if (noOfficeBreakdown.other > 0) {
            const percentage = ((noOfficeBreakdown.other / noOfficeCount) * 100).toFixed(1);
            rows.push({
                style: 'background-color: #f8f9fa;',
                cells: [
                    { content: 'Other Students', style: 'font-weight: bold;' },
                    { content: noOfficeBreakdown.other, style: 'text-align: right; font-weight: bold;' },
                    { content: `${percentage}%`, style: 'text-align: right; font-weight: bold;' }
                ]
            });

            const creditsBreakdown = noOfficeBreakdown.otherCreditsBreakdown;
            const addCreditsRow = (label, value) => {
                if (value > 0) {
                    const pct = ((value / noOfficeBreakdown.other) * 100).toFixed(1);
                    rows.push({
                        cells: [
                            { content: `  ${label}`, style: 'padding-left: 40px; font-size: 11px; color: #6c757d;' },
                            { content: value, style: 'text-align: right; font-size: 11px; color: #6c757d;' },
                            { content: `${pct}% of Other`, style: 'text-align: right; font-size: 11px; color: #6c757d;' }
                        ]
                    });
                }
            };
            addCreditsRow('Null/Missing Credits', creditsBreakdown.null);
            addCreditsRow('0 Credits', creditsBreakdown.zero);
            addCreditsRow('1 to 14 Credits', creditsBreakdown.oneToFourteen);
            addCreditsRow('15+ Credits', creditsBreakdown.fifteenPlus);
        }

        html += utils.createTable(headers, rows, {
            grandTotal: {
                color: '#333',
                cells: [
                    { content: 'TOTAL ‚Äî No Office' },
                    { content: noOfficeCount, align: 'right' },
                    { content: '100.0%', align: 'right' }
                ]
            }
        });
    }
    
    // === Median Caseload by Advising Office ===
    html += '<div id="medianCaseloadContainer">';
    html += generateMedianCaseloadTables(analytics.officeDetailedStats, analytics.advisorAssignmentsFlat, analytics.studentAdvisorOfficeMap);
    html += '</div>';
    
    // === New: Advisor Assignments (Unified Table) ===
    if (advisorAssignmentsFlat) {
        html += '<h4 style="color:#333; margin: 24px 0 10px;">üßë‚Äçüè´ Advisor Assignments</h4>';
        html += '<div style="font-size:12px; color:#6c757d; margin-bottom:10px;">Counts reflect the number of unique students assigned to each advisor. Each advisor appears in only one office based on their role. <strong>Uncheck advisors to exclude them from the Median Caseload calculations.</strong></div>';
        
        // Add select/deselect all buttons
        html += '<div style="margin-bottom: 15px;">';
        html += '<button onclick="selectAllAdvisors()" style="background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 12px;">Select All</button>';
        html += '<button onclick="deselectAllAdvisors()" style="background-color: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Deselect All</button>';
        html += '</div>';
        
        const headers = [
            { title: '‚úì', align: 'center' },
            { title: 'Advisor', align: 'left' },
            { title: 'Advising Office', align: 'left' },
            { title: 'Exclusive Students', align: 'right' },
            { title: 'Shared Students', align: 'right' },
            { title: 'Total Assignments', align: 'right' }
        ];
        const rows = [];
        let grandExclusive = 0;
        let grandShared = 0;
        let grandTotal = 0;
        
        advisorAssignmentsFlat.forEach((item, index) => {
            grandExclusive += item.exclusive;
            grandShared += item.shared;
            grandTotal += item.count;
            
            // Create unique ID for checkbox
            const checkboxId = `advisor_checkbox_${index}`;
            const advisorKey = `${item.advisor}|${item.offices}`;
            
            rows.push({
                cells: [
                    { content: `<input type="checkbox" id="${checkboxId}" checked onchange="toggleAdvisor('${advisorKey.replace(/'/g, "\\'")}')" style="transform: scale(1.2);">`, style: 'text-align: center; width: 30px;' },
                    { content: item.advisor },
                    { content: item.offices || '' },
                    { content: item.exclusive, style: 'text-align:right;' },
                    { content: item.shared, style: 'text-align:right;' },
                    { content: item.count, style: 'text-align:right; font-weight:bold;' }
                ]
            });
        });
        html += utils.createTable(headers, rows, {
            grandTotal: {
                color: '#333',
                cells: [
                    { content: '', style: 'width: 30px;' },
                    { content: 'GRAND TOTAL', colspan: 2 },
                    { content: grandExclusive, align: 'right' },
                    { content: grandShared, align: 'right' },
                    { content: grandTotal, align: 'right' }
                ]
            }
        });
    }
    // === End New Section ===

return html;
}


        // Continue with remaining dashboard functions...
        
function generateAcademicDepartmentDashboard(analytics, totalRecords) {
    if (!analytics) return '<p>No academic department data available.</p>';
    const { departmentCounts, studentsWithNoMajor, studentsWithMajorButNoDept } = analytics;

    const studentsWithDepartments = Object.values(departmentCounts).reduce((sum, c) => sum + c, 0);
    const studentsWithoutDepartments = studentsWithNoMajor + studentsWithMajorButNoDept;
    const distinctDepartments = Object.keys(departmentCounts).length;

    let html = '<h4 style="color:#333;margin-bottom:15px;">üéì Academic Department Distribution</h4>';

    // Summary cards
    html += `
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <div style="flex:1 1 220px;background:#e7f3ff;border:1px solid #b8daf5;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0b4f8a;font-weight:600;">Total Students</div>
        <div style="font-size:24px;font-weight:800;color:#0b4f8a;">${totalRecords}</div>
      </div>
      <div style="flex:1 1 220px;background:#eafaf1;border:1px solid #bfe8d0;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0f6b3a;font-weight:600;">With Department</div>
        <div style="font-size:24px;font-weight:800;color:#0f6b3a;">${studentsWithDepartments}</div>
        <div style="font-size:12px;color:#0f6b3a;">${((studentsWithDepartments/totalRecords)*100).toFixed(1)}%</div>
      </div>
      <div style="flex:1 1 220px;background:#fff7e6;border:1px solid #ffe0a6;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#8a5b0b;font-weight:600;">Without Department</div>
        <div style="font-size:24px;font-weight:800;color:#8a5b0b;">${studentsWithoutDepartments}</div>
        <div style="font-size:12px;color:#8a5b0b;">${((studentsWithoutDepartments/totalRecords)*100).toFixed(1)}%</div>
      </div>
      <div style="flex:1 1 220px;background:#fdecee;border:1px solid #f5c2c7;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#7e1e2a;font-weight:600;">Distinct Departments</div>
        <div style="font-size:24px;font-weight:800;color:#7e1e2a;">${distinctDepartments}</div>
      </div>
    </div>`;

    // Table
    const headers = [
        { title: 'Academic Department', align: 'left' },
        { title: 'Student Count', align: 'right' },
        { title: 'Percentage', align: 'right' }
    ];
    const rows = [];

    if (distinctDepartments > 0) {
        rows.push({ cells: [{ content: 'Students with Academic Department', style: 'background-color:#e7f3ff;font-weight:bold;', colspan:3 }] });
        // Sort ALPHABETICALLY
        const sortedDepartments = Object.entries(departmentCounts)
            .sort(([a],[b]) => a.localeCompare(b));
        sortedDepartments.forEach(([dept, count]) => {
            const pct = ((count/totalRecords)*100).toFixed(1);
            rows.push({
                cells:[
                    { content: dept, style:'font-weight:600;' },
                    { content: count, style:'text-align:right;color:#28a745;font-weight:bold;' },
                    { content: `${pct}%`, style:'text-align:right;' }
                ]
            });
        });
    }

    if (studentsWithoutDepartments > 0) {
        rows.push({ cells: [{ content: '‚ö†Ô∏è Students without Academic Department', style: 'background-color:#fff3cd;font-weight:bold;', colspan:3 }] });
        if (studentsWithNoMajor > 0) {
            const pct = ((studentsWithNoMajor/totalRecords)*100).toFixed(1);
            rows.push({
                style:'background-color:#fffbf0;',
                cells:[
                    { content:'No Major Listed', style:'color:#856404;font-style:italic;' },
                    { content:studentsWithNoMajor, style:'text-align:right;color:#856404;font-weight:bold;' },
                    { content:`${pct}%`, style:'text-align:right;color:#856404;' }
                ]
            });
        }
        if (studentsWithMajorButNoDept > 0) {
            const pct = ((studentsWithMajorButNoDept/totalRecords)*100).toFixed(1);
            rows.push({
                style:'background-color:#f8d7da;',
                cells:[
                    { content:'Major Listed but No Department Mapping', style:'color:#721c24;font-style:italic;' },
                    { content:studentsWithMajorButNoDept, style:'text-align:right;color:#721c24;font-weight:bold;' },
                    { content:`${pct}%`, style:'text-align:right;color:#721c24;' }
                ]
            });
        }
    }

    html += utils.createTable(headers, rows, {
        grandTotal: {
            color: '#333',
            cells: [
                { content: 'GRAND TOTAL' },
                { content: totalRecords, align: 'right' },
                { content: '100.0%', align: 'right' }
            ]
        }
    });

    if (studentsWithMajorButNoDept > 0) {
        html += '<div style="margin-top:20px;padding:15px;background-color:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;">';
        html += '<h5 style="margin-top:0;color:#856404;">üìã Students with Majors but No Department Mapping</h5>';
        html += '<p style="margin:0;color:#721c24;">These students have a major but could not be mapped to a department; review mappings for new or variant majors.</p>';
        html += '</div>';
    }

    return html;
}


        
function generateFacultyDashboard(analytics) {
    if (!analytics) return '<p>No faculty data available.</p>';
    let html = '<h4 style="color:#333;margin-bottom:15px;">üë®‚Äçüè´ Faculty Mentor Dashboard</h4>';

    // Calculate relationships & multiples
    const totalRelationships = Object.values(analytics.departmentStats).reduce((sum, d) => sum + d.students, 0);
    const multipleMentorCount = Math.max(0, totalRelationships - analytics.totalStudents);
    const avg = analytics.avgStudentsPerStaff;

    // Summary cards
    html += `
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <div style="flex:1 1 220px;background:#e7f3ff;border:1px solid #b8daf5;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0b4f8a;font-weight:600;">Total Mentors</div>
        <div style="font-size:24px;font-weight:800;color:#0b4f8a;">${analytics.totalStaff}</div>
      </div>
      <div style="flex:1 1 220px;background:#eafaf1;border:1px solid #bfe8d0;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0f6b3a;font-weight:600;">Students with Mentors</div>
        <div style="font-size:24px;font-weight:800;color:#0f6b3a;">${analytics.totalStudents}</div>
      </div>
      <div style="flex:1 1 220px;background:#fff7e6;border:1px solid #ffe0a6;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#8a5b0b;font-weight:600;">Total Relationships</div>
        <div style="font-size:24px;font-weight:800;color:#8a5b0b;">${totalRelationships}</div>
        <div style="font-size:12px;color:#8a5b0b;">Multiple-Mentor Links: ${multipleMentorCount}</div>
      </div>
      <div style="flex:1 1 220px;background:#fdecee;border:1px solid #f5c2c7;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#7e1e2a;font-weight:600;">Avg Students per Mentor</div>
        <div style="font-size:24px;font-weight:800;color:#7e1e2a;">${avg}</div>
      </div>
    </div>`;

    // Department breakdown table (alpha by dept)
    html += '<h5 style="color:#333;margin-bottom:15px;">üìä Faculty Department Breakdown</h5>';
    const headers = [
        { title: 'Faculty Department', align: 'left' },
        { title: 'Mentors', align: 'right' },
        { title: 'Students', align: 'right' },
        { title: 'Avg per Mentor', align: 'right' }
    ];
    const sortedDepartments = Object.entries(analytics.departmentStats).sort(([a],[b]) => a.localeCompare(b));
    let totalMentors = 0, totalStudents = 0;
    const rows = sortedDepartments.map(([dept, stats]) => {
        totalMentors += stats.staff;
        totalStudents += stats.students;
        return {
            cells: [
                { content: dept },
                { content: stats.staff, style:'text-align:right;' },
                { content: stats.students, style:'text-align:right;' },
                { content: stats.avg, style:'text-align:right;' }
            ]
        };
    });
    const grandTotalAvg = totalMentors > 0 ? (totalStudents/totalMentors).toFixed(1) : '0.0';
    html += utils.createTable(headers, rows, {
        grandTotal: {
            color:'#333',
            cells:[
                { content:'GRAND TOTAL' },
                { content: totalMentors, align:'right' },
                { content: totalStudents, align:'right' },
                { content: grandTotalAvg, align:'right' }
            ]
        }
    });

    
    // Subdepartment breakouts within each department
    if (analytics.departmentSubStats && Object.keys(analytics.departmentSubStats).length > 0) {
        html += '<div style="margin-top:16px;"></div>';
        html += '<h6 style="margin:8px 0;color:#555;">‚ñ∏ Subdepartment Breakouts (within each Faculty Department)</h6>';
        const depts = Object.keys(analytics.departmentSubStats).sort((a,b)=>a.localeCompare(b));
        depts.forEach(dept => {
            const subMap = analytics.departmentSubStats[dept];
            const subs = Object.keys(subMap).sort((a,b)=>a.localeCompare(b));
            let tMent = 0, tStud = 0;
            const rowsSub = subs.map(sub => {
                const s = subMap[sub];
                tMent += s.staff; 
                tStud += s.students;
                return { cells:[
                    { content: sub },
                    { content: s.staff, style:'text-align:right;' },
                    { content: s.students, style:'text-align:right;' },
                    { content: s.avg, style:'text-align:right;' }
                ]};
            });
            const deptAvg = tMent > 0 ? (tStud / tMent).toFixed(1) : '0.0';
            html += `<div style="margin:10px 0 16px 0;padding:12px;border:1px solid #e9ecef;border-radius:8px;background:#fafbfc;">
                        <div style="font-weight:700;margin-bottom:6px;color:#333;">${dept}</div>`;
            html += utils.createTable(
                [
                    { title: 'Faculty Academic Department_sub', align: 'left' },
                    { title: 'Mentors', align: 'right' },
                    { title: 'Students', align: 'right' },
                    { title: 'Avg per Mentor', align: 'right' }
                ],
                rowsSub,
                {
                    grandTotal: {
                        color:'#333',
                        cells:[
                            { content:'SUBTOTAL' },
                            { content: tMent, align:'right' },
                            { content: tStud, align:'right' },
                            { content: deptAvg, align:'right' }
                        ]
                    }
                }
            );
            html += `</div>`;
        });
    }
// Data Quality
    if (analytics.dataQuality) {
        html += '<div style="margin-top:30px;border-top:2px solid #dee2e6;padding-top:20px;">';
        html += '<h5 style="margin-top:0;color:#dc3545;">üîç Faculty Data Quality Report</h5>';
        const { dataQuality } = analytics;
        const hasIssues = dataQuality.facultyInCaseloadNotInFile.length > 0 || dataQuality.facultyInFileNotInCaseload.length > 0;
        if (hasIssues) {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;">';
            html += '<p style="margin:0 0 10px 0;font-weight:bold;color:#856404;">‚ö†Ô∏è Faculty Data Mismatches Found:</p>';
            if (dataQuality.facultyInCaseloadNotInFile.length > 0) {
                html += `<p style="margin:5px 0;color:#721c24;"><strong>Faculty in Caseload but NOT in Faculty File (${dataQuality.facultyInCaseloadNotInFile.length}):</strong></p>`;
                const groupedByDept = {};
                dataQuality.facultyInCaseloadNotInFile.forEach(faculty => {
                    const dept = dataQuality.facultyDepartmentMap[faculty] || 'Unknown Department';
                    if (!groupedByDept[dept]) groupedByDept[dept] = [];
                    groupedByDept[dept].push(faculty);
                });
                Object.keys(groupedByDept).sort().forEach(dept => {
                    html += `<div style="margin:10px 0 10px 20px;padding:8px;background-color:#fff8e7;border-left:3px solid #dc3545;border-radius:3px;">`;
                    html += `<strong style="color:#721c24;">${dept} (${groupedByDept[dept].length}):</strong><br>`;
                    html += '<ul style="margin:5px 0 0 20px;color:#721c24;">';
                    groupedByDept[dept].sort().forEach(f => html += `<li>${f}</li>`);
                    html += '</ul></div>';
                });
            }
            if (dataQuality.facultyInFileNotInCaseload.length > 0) {
                html += `<p style="margin:15px 0 5px 0;color:#0c5460;"><strong>Faculty in List File but NOT in Caseload (${dataQuality.facultyInFileNotInCaseload.length}):</strong></p>`;
                const groupedByDept = {};
                dataQuality.facultyInFileNotInCaseload.forEach(faculty => {
                    const dept = dataQuality.fileFacultyDepartmentMap[faculty] || 'Unknown Department';
                    if (!groupedByDept[dept]) groupedByDept[dept] = [];
                    groupedByDept[dept].push(faculty);
                });
                Object.keys(groupedByDept).sort().forEach(dept => {
                    html += `<div style="margin:10px 0 10px 20px;padding:8px;background-color:#e7f3ff;border-left:3px solid #17a2b8;border-radius:3px;">`;
                    html += `<strong style="color:#0c5460;">${dept} (${groupedByDept[dept].length}):</strong><br>`;
                    html += '<ul style="margin:5px 0 0 20px;color:#0c5460;">';
                    groupedByDept[dept].sort().forEach(f => html += `<li>${f}</li>`);
                    html += '</ul></div>';
                });
            }
            html += `<p style="margin:10px 0 0 0;font-size:12px;color:#856404;"><em>Summary: ${dataQuality.totalFacultyInCaseload} unique faculty in caseload, ${dataQuality.totalFacultyInFile} in faculty file</em></p>`;
            html += '</div>';
        } else {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#d4edda;border:1px solid #c3e6cb;border-radius:5px;">';
            html += '<p style="margin:0;font-weight:bold;color:#155724;">‚úÖ All faculty mentors match between files!</p>';
            html += `<p style="margin:5px 0 0 0;font-size:12px;color:#155724;"><em>${dataQuality.totalFacultyInCaseload} unique faculty found in both files</em></p>`;
            html += '</div>';
        }
        html += '</div>';
    }

    // Mismatch analysis block (unchanged)
    if (analytics.departmentMismatchAnalysis) {
        const { departmentMismatchAnalysis } = analytics;
        html += '<div style="margin-top:30px;border-top:2px solid #dee2e6;padding-top:20px;">';
        html += '<h5 style="margin-top:0;color:#dc3545;">üîç Faculty-Student Department Mismatch Analysis</h5>';
        if (departmentMismatchAnalysis.totalMismatches > 0) {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;">';
            html += `<p style="margin:0 0 10px 0;font-weight:bold;color:#856404;">‚ö†Ô∏è Found ${departmentMismatchAnalysis.totalMismatches} Faculty-Student Department Mismatches:</p>`;
            html += '<p style="margin:0;color:#856404;font-size:14px;">Cases where mentors are assigned outside their department specialization.</p>';
            html += '</div>';
            const mismatchHeaders = [
                { title: 'Faculty Academic Department_sub', align: 'left' },
                { title: 'Student Academic Department_sub', align: 'left' },
                { title: 'Mismatch Count', align: 'right' }
            ];
            const rows = [];
            let totalMismatchCount = 0;
            const sorted = Object.entries(departmentMismatchAnalysis.mismatches)
                .sort(([a, cA], [b, cB]) => {
                    if (cB !== cA) return cB - cA;
                    const [fa, sa] = a.split(' ‚Üí ');
                    const [fb, sb] = b.split(' ‚Üí ');
                    return fa === fb ? sa.localeCompare(sb) : fa.localeCompare(fb);
                });
            sorted.forEach(([key, count]) => {
                const [f, s] = key.split(' ‚Üí ');
                totalMismatchCount += count;
                rows.push({ cells:[
                    { content:f, style:'font-weight:600;color:#0056b3;' },
                    { content:s, style:'font-weight:600;color:#dc3545;' },
                    { content:count, style:'text-align:right;font-weight:bold;color:#e67e22;' }
                ]});
            });
            html += utils.createTable(mismatchHeaders, rows, {
                grandTotal: {
                    color:'#dc3545',
                    cells:[
                        { content:'TOTAL MISMATCHES', colspan:2 },
                        { content: totalMismatchCount, align:'right' }
                    ]
                }
            });
            html += '<div style="margin-top:15px;padding:10px;background-color:#f8f9fa;border-radius:5px;font-size:12px;">';
            html += '<strong>Note:</strong> Mismatches can reflect cross-department mentoring or data issues.';
            html += '</div>';
        } else {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#d4edda;border:1px solid #c3e6cb;border-radius:5px;">';
            html += '<p style="margin:0;font-weight:bold;color:#155724;">‚úÖ No Faculty-Student Department Mismatches Found!</p>';
            html += '<p style="margin:5px 0 0 0;font-size:12px;color:#155724;"><em>All mentors align with student departments.</em></p>';
            html += '</div>';
        }
        html += '</div>';
    }

    // Multiple Mentor Assignments section
    if (analytics.multiMentorStats) {
        const { multiMentorStats } = analytics;
        const sameDeptCount = multiMentorStats.sameDept.length;
        const diffDeptCount = multiMentorStats.diffDept.length;
        const totalMultiple = sameDeptCount + diffDeptCount;
        
        html += '<div style="margin-top:30px;border-top:2px solid #dee2e6;padding-top:20px;">';
        html += '<h5 style="margin-top:0;color:#6f42c1;">üë• Students with Multiple Faculty Mentors</h5>';
        
        if (totalMultiple > 0) {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#f0e9ff;border:1px solid #cfbdf9;border-radius:5px;">';
            html += `<p style="margin:0 0 10px 0;font-weight:bold;color:#4b2ca3;">Found ${totalMultiple} students with multiple faculty mentor assignments:</p>`;
            html += '</div>';
            
            const multiHeaders = [
                { title: 'Assignment Type', align: 'left' },
                { title: 'Student Count', align: 'right' },
                { title: 'Percentage', align: 'right' }
            ];
            const multiRows = [];
            
            // Same department row
            if (sameDeptCount > 0) {
                const samePct = ((sameDeptCount / totalMultiple) * 100).toFixed(1);
                multiRows.push({
                    cells: [
                        { content: 'Multiple Mentors ‚Äî Same Department', style: 'font-weight:600;' },
                        { content: sameDeptCount, style: 'text-align:right;' },
                        { content: `${samePct}%`, style: 'text-align:right;' }
                    ]
                });
                
                // Breakdown by department
                const sortedDepts = Object.entries(multiMentorStats.sameDeptByDept)
                    .sort(([a], [b]) => a.localeCompare(b));
                sortedDepts.forEach(([dept, count], index) => {
                    const isLast = index === sortedDepts.length - 1;
                    const prefix = isLast ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
                    const deptPct = ((count / sameDeptCount) * 100).toFixed(1);
                    multiRows.push({
                        cells: [
                            { content: `${prefix} ${dept}`, style: 'padding-left:30px; font-size:13px; color:#6c757d;' },
                            { content: count, style: 'text-align:right; font-size:13px; color:#6c757d;' },
                            { content: `${deptPct}% of same-dept`, style: 'text-align:right; font-size:13px; color:#6c757d;' }
                        ]
                    });
                });
            }
            
            // Different departments row
            if (diffDeptCount > 0) {
                const diffPct = ((diffDeptCount / totalMultiple) * 100).toFixed(1);
                multiRows.push({
                    cells: [
                        { content: 'Multiple Mentors ‚Äî Different Departments', style: 'font-weight:600;' },
                        { content: diffDeptCount, style: 'text-align:right;' },
                        { content: `${diffPct}%`, style: 'text-align:right;' }
                    ]
                });
            }
            
            html += utils.createTable(multiHeaders, multiRows, {
                grandTotal: {
                    color: '#4b2ca3',
                    cells: [
                        { content: 'TOTAL ‚Äî Multiple Mentors' },
                        { content: totalMultiple, align: 'right' },
                        { content: '100.0%', align: 'right' }
                    ]
                }
            });
            
            html += '<div style="margin-top:15px;padding:10px;background-color:#f8f9fa;border-radius:5px;font-size:12px;">';
            html += '<strong>Note:</strong> Students with multiple mentors are counted once per department they appear in for department-level statistics.';
            html += '</div>';
        } else {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#d4edda;border:1px solid #c3e6cb;border-radius:5px;">';
            html += '<p style="margin:0;font-weight:bold;color:#155724;">‚úÖ No students have multiple faculty mentor assignments.</p>';
            html += '</div>';
        }
        html += '</div>';
    }

    return html;
}


        
function generatePeerDashboard(analytics, totalRecords) {
    if (!analytics) return '<p>No peer advisor data available.</p>';
    let html = '<h4 style="color:#6f42c1;margin-bottom:15px;">üë• Peer Advisor Dashboard</h4>';

    // Summary cards
    html += `
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <div style="flex:1 1 220px;background:#e7f3ff;border:1px solid #b8daf5;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0b4f8a;font-weight:600;">Total Students</div>
        <div style="font-size:24px;font-weight:800;color:#0b4f8a;">${totalRecords}</div>
      </div>
      <div style="flex:1 1 220px;background:#f0e9ff;border:1px solid #cfbdf9;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#4b2ca3;font-weight:600;">With Peer Advisors</div>
        <div style="font-size:24px;font-weight:800;color:#4b2ca3;">${analytics.totalStudentsWithPeers}</div>
      </div>
      <div style="flex:1 1 220px;background:#eafaf1;border:1px solid #bfe8d0;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#0f6b3a;font-weight:600;">Assignment Rate</div>
        <div style="font-size:24px;font-weight:800;color:#0f6b3a;">${analytics.peerAssignmentPercentage}%</div>
      </div>
      <div style="flex:1 1 220px;background:#fdecee;border:1px solid #f5c2c7;border-radius:8px;padding:14px;">
        <div style="font-size:12px;color:#7e1e2a;font-weight:600;">Unique Peers</div>
        <div style="font-size:24px;font-weight:800;color:#7e1e2a;">${analytics.totalUniquePeers}</div>
      </div>
    </div>`;

    // Students by Academic Department (filtered and sorted)
    const filteredDeptStats = Object.fromEntries(
        Object.entries(analytics.departmentStats)
            .filter(([dept, stats]) => stats.totalStudents > 0 && dept !== 'NONDEGREE' && dept !== 'Unknown')
            .sort(([a],[b]) => a.localeCompare(b))
    );

    if (Object.keys(filteredDeptStats).length > 0) {
        html += '<h5 style="color:#6f42c1;">Students by Academic Department</h5>';
        const headers = [
            { title: 'Student Department', align: 'left' },
            { title: 'Total Students', align: 'right' },
            { title: 'With Peer Advisors', align: 'right' },
            { title: 'Assignment %', align: 'right' }
        ];
        let grandTotalStudents = 0, grandTotalWithPeers = 0;
        const rows = Object.entries(filteredDeptStats).map(([dept, stats]) => {
            const pct = stats.totalStudents > 0 ? ((stats.withPeers / stats.totalStudents) * 100).toFixed(1) : '0.0';
            grandTotalStudents += stats.totalStudents;
            grandTotalWithPeers += stats.withPeers;
            return {
                cells:[
                    { content: dept },
                    { content: stats.totalStudents, style:'text-align:right;' },
                    { content: stats.withPeers, style:'text-align:right;color:#6f42c1;' },
                    { content: `${pct}%`, style:'text-align:right;' }
                ]
            };
        });
        const grandPct = grandTotalStudents > 0 ? ((grandTotalWithPeers / grandTotalStudents) * 100).toFixed(1) : '0.0';
        html += utils.createTable(headers, rows, {
            grandTotal: {
                color:'#6f42c1',
                cells:[
                    { content:'GRAND TOTAL' },
                    { content: grandTotalStudents, align:'right' },
                    { content: grandTotalWithPeers, align:'right' },
                    { content: `${grandPct}%`, align:'right' }
                ]
            }
        });
    }

    // Peer Advisor Assignments (filtered and sorted)
    const filteredPeerStats = Object.fromEntries(
        Object.entries(analytics.peerAssignmentStats)
            .filter(([dept, data]) => Object.keys(data.peers).length > 0 && dept !== 'NONDEGREE' && dept !== 'Unknown')
            .sort(([a],[b]) => a.localeCompare(b))
    );

    if (Object.keys(filteredPeerStats).length > 0) {
        html += '<h5 style="color:#6f42c1;">Peer Advisor Assignments</h5>';
        const headers = [
            { title: 'Peer Department', align: 'left' },
            { title: 'Peer Advisor Name', align: 'left' },
            { title: 'Students Assigned', align: 'right' }
        ];
        const rows = [];
        let grandTotalAssignments = 0;
        Object.entries(filteredPeerStats).forEach(([dept, data]) => {
            const peerEntries = Object.entries(data.peers).sort(([a],[b]) => a.localeCompare(b));
            peerEntries.forEach(([peerName, count], idx) => {
                const row = { cells: [] };
                if (idx === 0) {
                    row.cells.push({ content: dept, style:'vertical-align:top;font-weight:bold;', rowspan: peerEntries.length });
                }
                row.cells.push({ content: peerName });
                row.cells.push({ content: count, style:'text-align:right;color:#6f42c1;' });
                rows.push(row);
                grandTotalAssignments += count;
            });
        });
        html += utils.createTable(headers, rows, {
            grandTotal: {
                color:'#6f42c1',
                cells:[
                    { content:'GRAND TOTAL', colspan:2 },
                    { content: grandTotalAssignments, align:'right' }
                ]
            }
        });
    }

    // Data quality block remains as-is from previous function (already below in original)
    if (analytics.dataQuality) {
        html += '<h5 style="color:#dc3545;margin-top:15px;">üîç Data Quality Report</h5>';
        const { dataQuality } = analytics;
        const hasIssues = dataQuality.peersInCaseloadNotInFile.length > 0 || dataQuality.peersInFileNotInCaseload.length > 0;
        if (hasIssues) {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#fff3cd;border:1px solid #ffeaa7;border-radius:5px;">';
            html += '<p style="margin:0 0 10px 0;font-weight:bold;color:#856404;">‚ö†Ô∏è Data Mismatches Found:</p>';
            if (dataQuality.peersInCaseloadNotInFile.length > 0) {
                html += `<p style="margin:5px 0;color:#721c24;"><strong>Peers in Caseload but NOT in Peer File (${dataQuality.peersInCaseloadNotInFile.length}):</strong></p>`;
                html += '<ul style="margin:5px 0 15px 20px;color:#721c24;">';
                dataQuality.peersInCaseloadNotInFile.forEach(p => html += `<li>${p}</li>`);
                html += '</ul>';
            }
            if (dataQuality.peersInFileNotInCaseload.length > 0) {
                html += `<p style="margin:5px 0;color:#0c5460;"><strong>Peers in Peer File but NOT in Caseload (${dataQuality.peersInFileNotInCaseload.length}):</strong></p>`;
                html += '<ul style="margin:5px 0 15px 20px;color:#0c5460;">';
                dataQuality.peersInFileNotInCaseload.forEach(p => html += `<li>${p}</li>`);
                html += '</ul>';
            }
            html += `<p style="margin:10px 0 0 0;font-size:12px;color:#856404;"><em>Summary: ${dataQuality.totalPeersInCaseload} unique peers in caseload, ${dataQuality.totalPeersInFile} in peer file</em></p>`;
            html += '</div>';
        } else {
            html += '<div style="margin-bottom:20px;padding:15px;background-color:#d4edda;border:1px solid #c3e6cb;border-radius:5px;">';
            html += '<p style="margin:0;font-weight:bold;color:#155724;">‚úÖ All peer advisors match between files!</p>';
            html += `<p style="margin:5px 0 0 0;font-size:12px;color:#155724;"><em>${dataQuality.totalPeersInCaseload} unique peers found in both files</em></p>`;
            html += '</div>';
        }
    }

    return html;
}


        function generateCategoryManagerDashboard(analytics) {
            if (!analytics) return '<p>No category data available.</p>';
            
            const { totalCategories, totalStudents, featuredCategories, otherCategories } = analytics;
            
            let html = '<h4 style="color: #28a745; margin-bottom: 15px;">üìã Category Manager</h4>' +
  `<div style="display:flex;gap:12px;align-items:center;margin:10px 0 14px 0;">`
 + `<label>Year <input id="cm-year" type="number" min="2000" max="2100" value="${TERM_STATE.year}" style="width:90px;padding:4px 6px;border:1px solid #ccc;border-radius:6px;"/></label>`
 + `<label>Term <select id="cm-term" style="padding:4px 6px;border:1px solid #ccc;border-radius:6px;"><option value="FA" ${TERM_STATE.termCode==='FA'?'selected':''}>FA</option><option value="SP" ${TERM_STATE.termCode==='SP'?'selected':''}>SP</option></select></label>`
 + `<button id="cm-apply" class="btn btn-sm" style="padding:6px 10px;border:1px solid #007bff;border-radius:6px;background:#007bff;color:#fff;">Apply</button>`
 + `</div>`;

            
            // Summary statistics
            html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px;">';
            html += `<strong>Total Categories Found:</strong> ${totalCategories} (${featuredCategories.length} featured + ${otherCategories.length} other)<br>`;
            html += `<strong>Total Students:</strong> ${totalStudents}<br>`;
            html += '<span style="color: #155724;">Select which categories to include as columns in your CSV export. Major categories are excluded since they\'re extracted separately.</span>';
            html += '</div>';
            
            // Control buttons
            html += '<div style="margin-bottom: 20px;">';
            html += '<button onclick="selectAllCategories()" style="background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Select All</button>';
            html += '<button onclick="deselectAllCategories()" style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Deselect All</button>';
            html += '<button onclick="selectOnlyFeatured()" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Select Only Featured</button>';
            html += '<button onclick="selectOnlyCommon()" style="background-color: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Select Only Common (>5%)</button>';
            html += '</div>';
            
            if (totalCategories > 0) {
                // Featured Categories Section
                if (featuredCategories.length > 0) {
                    html += '<div style="margin-bottom: 30px;">';
                    html += '<h5 style="color: #007bff; margin-bottom: 15px; padding: 10px; background-color: #e7f3ff; border-left: 4px solid #007bff;">‚≠ê Featured Categories</h5>';
                    html += generateCategoryTable(featuredCategories, totalStudents, 'featured');
                    html += '</div>';
                }
                
                // Other Categories Section
                if (otherCategories.length > 0) {
                    html += '<div>';
                    html += '<h5 style="color: #6c757d; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #6c757d;">üìÇ Other Categories</h5>';
                    html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;">';
                    html += generateCategoryTable(otherCategories, totalStudents, 'other');
                    html += '</div>';
                    html += '</div>';
                }
                
                // Legend
                html += '<div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-size: 12px;">';
                html += '<strong>Legend:</strong> ';
                html += '<span style="background-color: #e7f3ff; padding: 2px 6px; border-radius: 3px; margin-left: 10px;">Blue rows</span> = Featured categories ';
                html += '<span style="background-color: #fff3cd; padding: 2px 6px; border-radius: 3px; margin-left: 10px;">Yellow rows</span> = Common categories (>5% of students)';
                html += '</div>';
                
                // Current selection summary
                html += '<div style="margin-top: 20px; padding: 15px; background-color: #e7f3ff; border: 1px solid #b8dae5; border-radius: 5px;">';
                html += '<h5 style="margin-top: 0; color: #0c5460;">üìä Current Selection Summary</h5>';
                html += '<div id="selectionSummary">';
                const totalSelected = featuredCategories.filter(([,stats]) => stats.selected).length + otherCategories.filter(([,stats]) => stats.selected).length;
                html += `<strong>Selected Categories:</strong> <span id="selectedCount">${totalSelected}</span> of ${totalCategories}<br>`;
                html += '<strong>These categories will be included as Yes/No columns in your CSV export.</strong>';
                html += '</div>';
                html += '</div>';
                
            } else {
                html += '<div style="text-align: center; padding: 20px; color: #666; font-style: italic;">No categories found in the data.</div>';
            }
            
            return html;
        }

        function generateCategoryTable(categories, totalStudents, section) {
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            
            if (section === 'featured') {
                html += '<thead style="background-color: #e7f3ff;">';
            } else {
                html += '<thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">';
            }
            
            html += '<tr>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: center; width: 60px;">Include</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Category</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: right; width: 100px;">Student Count</th>';
            html += '<th style="border: 1px solid #dee2e6; padding: 10px; text-align: right; width: 100px;">% of Students</th>';
            html += '</tr></thead><tbody>';
            
            categories.forEach(([category, stats], index) => {
                const percentage = ((stats.count / totalStudents) * 100).toFixed(1);
                const isCommon = parseFloat(percentage) > 5;
                const isFeatured = section === 'featured';
                
                let rowStyle = '';
                if (isFeatured) {
                    rowStyle = 'style="background-color: #f0f8ff;"';
                } else if (isCommon) {
                    rowStyle = 'style="background-color: #fff3cd;"';
                }
                
                const checkboxId = `category_${section}_${index}`;
                
                html += `<tr ${rowStyle}>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">`;
                html += `<input type="checkbox" id="${checkboxId}" ${stats.selected ? 'checked' : ''} onchange="toggleCategory('${category.replace(/'/g, "\\'")}', this.checked)" style="transform: scale(1.2);">`;
                html += `</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 8px; font-size: 13px;">${category}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 8px; text-align: right; font-weight: bold; color: #28a745;">${stats.count}</td>`;
                html += `<td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">${percentage}%</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Category management functions
        window.toggleCategory = function(category, selected) {
            selectedCategories[category] = selected;
            updateSelectionSummary();
        };

        window.selectAllCategories = function() {
            document.querySelectorAll('input[type="checkbox"][id^="category_"]').forEach(cb => {
                cb.checked = true;
            });
            // Update selectedCategories object
            Object.keys(selectedCategories).forEach(category => {
                selectedCategories[category] = true;
            });
            updateSelectionSummary();
        };

        window.deselectAllCategories = function() {
            document.querySelectorAll('input[type="checkbox"][id^="category_"]').forEach(cb => {
                cb.checked = false;
            });
            // Update selectedCategories object
            Object.keys(selectedCategories).forEach(category => {
                selectedCategories[category] = false;
            });
            updateSelectionSummary();
        };

        window.selectOnlyFeatured = function() {
            document.querySelectorAll('input[type="checkbox"][id^="category_"]').forEach(cb => {
                const isFeatured = cb.id.includes('featured');
                cb.checked = isFeatured;
            });
            // Update selectedCategories object based on featured status
            // Use the stored analytics instead of recalculating
            if (appState.analytics && appState.analytics.category) {
                const featuredCategoryNames = appState.analytics.category.featuredCategories.map(([cat, _]) => cat);
                Object.keys(selectedCategories).forEach(category => {
                    selectedCategories[category] = featuredCategoryNames.includes(category);
                });
            } else {
                // Fallback: just use the checkbox state
                Object.keys(selectedCategories).forEach(category => {
                    const cb = document.querySelector(`input[id*="category_"][onchange*="${category.replace(/'/g, "\\'")}"]`);
                    if (cb) {
                        selectedCategories[category] = cb.checked;
                    }
                });
            }
            updateSelectionSummary();
        };

        window.selectOnlyCommon = function() {
            // Get the total students count from stored analytics or from the data
            let totalStudents = appState.processedData ? appState.processedData.length : 0;
            if (appState.analytics && appState.analytics.category) {
                totalStudents = appState.analytics.category.totalStudents;
            }
            
            document.querySelectorAll('input[type="checkbox"][id^="category_"]').forEach(cb => {
                const row = cb.closest('tr');
                const percentageCell = row.querySelector('td:last-child');
                if (percentageCell) {
                    const percentage = parseFloat(percentageCell.textContent);
                    const isCommon = percentage > 5;
                    cb.checked = isCommon;
                }
            });
            
            // Update selectedCategories object based on percentage
            if (appState.analytics && appState.analytics.category && totalStudents > 0) {
                // Combine featured and other categories to find stats
                const allCategories = [
                    ...appState.analytics.category.featuredCategories,
                    ...appState.analytics.category.otherCategories
                ];
                
                Object.keys(selectedCategories).forEach(category => {
                    const categoryData = allCategories.find(([cat, _]) => cat === category);
                    if (categoryData) {
                        const percentage = ((categoryData[1].count / totalStudents) * 100);
                        selectedCategories[category] = percentage > 5;
                    } else {
                        selectedCategories[category] = false;
                    }
                });
            } else {
                // Fallback: just use the checkbox state
                Object.keys(selectedCategories).forEach(category => {
                    const cb = document.querySelector(`input[id*="category_"][onchange*="${category.replace(/'/g, "\\'")}"]`);
                    if (cb) {
                        selectedCategories[category] = cb.checked;
                    }
                });
            }
            
            updateSelectionSummary();
        };

        function updateSelectionSummary() {
            const selectedCount = Object.values(selectedCategories).filter(selected => selected).length;
            const selectedCountElement = document.getElementById('selectedCount');
            if (selectedCountElement) {
                selectedCountElement.textContent = selectedCount;
            }
        }

        window.copyProcessedData = function() {
            if (!appState.processedData) {
                alert('No processed data available to copy.');
                return;
            }
            
            const copyBtn = document.getElementById('copyBtn');
            const progressContainer = document.getElementById('copyProgressContainer');
            const progressFill = document.getElementById('copyProgressFill');
            const progressText = document.getElementById('copyProgressText');
            const progressDetails = document.getElementById('copyProgressDetails');
            
            // Disable button and show progress
            copyBtn.disabled = true;
            copyBtn.style.backgroundColor = '#6c757d';
            copyBtn.style.cursor = 'not-allowed';
            progressContainer.style.display = 'block';
            
            // Function to update progress
            const updateProgress = (percentage, text, details = '') => {
                progressFill.style.width = percentage + '%';
                progressText.textContent = text;
                progressDetails.textContent = details;
            };
            
            // Start progress
            updateProgress(0, 'Preparing CSV data...', 'Initializing column structure');
            
            setTimeout(() => {
                try {
                    updateProgress(10, 'Building column structure...', 'Organizing core columns');
                    
                    const coreColumns = [
                        CONSTANTS.COLUMNS.STUDENT_ID, CONSTANTS.COLUMNS.ASSIGNED_STAFF, CONSTANTS.COLUMNS.CATEGORY,
                        'Name', 'Cumulative GPA',
                        CONSTANTS.COLUMNS.NAV_M,
                        CONSTANTS.COLUMNS.Major,
                        'Predicted Support Level', 'Degree', 'Earned Credits',
                        CONSTANTS.COLUMNS.PROFESSIONAL_ADVISOR, CONSTANTS.COLUMNS.ADVISING_OFFICE,
                        CONSTANTS.COLUMNS.FACULTY_MENTOR, CONSTANTS.COLUMNS.PEER_ADVISOR, CONSTANTS.COLUMNS.PROGRAM_DIRECTOR,
                        CONSTANTS.COLUMNS.LIBRARIAN, CONSTANTS.COLUMNS.ACADEMIC_STANDING,
                        CONSTANTS.COLUMNS.STUDENT_DEPT, CONSTANTS.COLUMNS.STUDENT_DEPT_SUB
                    ];
                    
                    updateProgress(20, 'Analyzing available data...', 'Detecting all available columns');
                    
                    const allHeaders = new Set();
                    appState.processedData.forEach(record => {
                        Object.keys(record).forEach(key => allHeaders.add(key));
                    });
                    
                    let columnOrder = coreColumns.filter(col => allHeaders.has(col));
                    
                    updateProgress(35, 'Adding lookup columns...', 'Including staff ID and department columns');
                    
                    // Add lookup columns
                    if (appState.data.advisor) columnOrder.push('Staff ID');
                    if (appState.data.faculty) {
                        columnOrder.push('Mentor ID', 'Faculty Academic Department', 'Faculty Academic Department_sub', 'Faculty Academic Department_home');
                    }
                    if (appState.data.peer) {
                        columnOrder.push('Peer ID', 'Peer Academic Department');
                    }
                    
                    updateProgress(50, 'Processing category selections...', 'Adding selected category columns');
                    
                    // Add category columns based on selection
                    const selectedCategoryColumns = Object.entries(selectedCategories)
                        .filter(([_, selected]) => selected)
                        .map(([category, _]) => category)
                        .sort();
                    
                    updateProgress(65, 'Creating category columns...', `Processing ${selectedCategoryColumns.length} category columns`);
                    
                    // Create data with category columns
                    const dataWithCategories = appState.processedData.map(record => {
                        const newRecord = { ...record };
                        
                        // Add category columns as Yes/No
                        selectedCategoryColumns.forEach(category => {
                            const recordCategories = (record[CONSTANTS.COLUMNS.CATEGORY] || '').split(',').map(cat => cat.trim());
                            newRecord[category] = recordCategories.includes(category) ? 'Yes' : 'No';
                        });
                        
                        return newRecord;
                    });
                    
                    updateProgress(80, 'Finalizing column order...', 'Adding remaining columns');
                    
                    // Add selected category columns to column order
                    columnOrder.push(...selectedCategoryColumns);
                    
                    // Add any other headers that were in the raw data but not explicitly picked
                    allHeaders.forEach(header => {
                        if (!columnOrder.includes(header) && header !== 'Major') {
                            columnOrder.push(header);
                        }
                    });
                    
                    updateProgress(90, 'Generating CSV content...', `Converting ${appState.processedData.length} records to CSV format`);
                    
                    const csvContent = Papa.unparse({
                        fields: columnOrder,
                        data: dataWithCategories
                    });
                    
                    updateProgress(95, 'Copying to clipboard...', 'Transferring data to clipboard');
                    
                    navigator.clipboard.writeText(csvContent).then(() => {
                        updateProgress(100, 'Success!', 'CSV data copied to clipboard');
                        
                        const categoryCount = selectedCategoryColumns.length;
                        setTimeout(() => {
                            alert(`CSV data copied to clipboard! ${appState.processedData.length} records with ${columnOrder.length} columns (including ${categoryCount} selected category columns).`);
                            
                            // Reset button and hide progress
                            copyBtn.disabled = false;
                            copyBtn.style.backgroundColor = '#17a2b8';
                            copyBtn.style.cursor = 'pointer';
                            progressContainer.style.display = 'none';
                        }, 500);
                        
                    }).catch(() => {
                        // Fallback for older browsers
                        updateProgress(98, 'Using fallback method...', 'Clipboard API unavailable, using fallback');
                        
                        const textArea = document.createElement('textarea');
                        textArea.value = csvContent;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        updateProgress(100, 'Success!', 'CSV data copied to clipboard (fallback method)');
                        
                        const categoryCount = selectedCategoryColumns.length;
                        setTimeout(() => {
                            alert(`CSV data copied to clipboard! ${appState.processedData.length} records with ${columnOrder.length} columns (including ${categoryCount} selected category columns).`);
                            
                            // Reset button and hide progress
                            copyBtn.disabled = false;
                            copyBtn.style.backgroundColor = '#17a2b8';
                            copyBtn.style.cursor = 'pointer';
                            progressContainer.style.display = 'none';
                        }, 500);
                    });
                    
                } catch (error) {
                    updateProgress(0, 'Error occurred', 'Failed to prepare CSV data');
                    alert('Error preparing data for copy: ' + error.message);
                    
                    // Reset button and hide progress
                    copyBtn.disabled = false;
                    copyBtn.style.backgroundColor = '#17a2b8';
                    copyBtn.style.cursor = 'pointer';
                    progressContainer.style.display = 'none';
                }
            }, 100);
        };

        // TAB SWITCHING
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.style.borderBottom = '3px solid transparent';
                button.style.fontWeight = 'normal';
                button.style.color = '#666';
            });
            
            document.getElementById(tabName + 'Content').style.display = 'block';
            
            const activeTab = document.getElementById(tabName + 'Tab');
            if (activeTab) {
                activeTab.style.borderBottom = '3px solid #007bff';
                activeTab.style.fontWeight = 'bold';
                activeTab.style.color = '#333';
            }
        };

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            ['main', 'advisor', 'faculty', 'peer'].forEach(type => {
                const input = document.getElementById(type + 'File');
                if (input) {
                    input.addEventListener('change', (e) => handleFileUpload(e, type));
                }
            });

            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.addEventListener('click', processFiles);
            }
            
            setTimeout(() => {
                utils.showStatus('System ready! Upload your main CSV file to begin.', 'info');
            }, 500);
        });
    
// Category Manager: Apply Year/Term
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'cm-apply'){
    const y = parseInt(document.getElementById('cm-year').value, 10);
    const t = document.getElementById('cm-term').value;
    if (!isNaN(y) && (t==='FA' || t==='SP')){
      TERM_STATE.year = y;
      TERM_STATE.termCode = t;
      // trigger a re-render if function available
      if (typeof window.renderDashboard === 'function') {
        window.renderDashboard(); // full refresh
      } else if (typeof window.refreshCategoryManager === 'function') {
        window.refreshCategoryManager();
      } else {
        // Fallback: force a simple reflow by switching tabs if you have tab controls; otherwise noop.
      }
    }
  }
});



function exportProcessedData() {
    try {
        if (!appState || !Array.isArray(appState.processedData) || appState.processedData.length === 0) {
            const msg = 'No data available to export yet. Generate the file first.';
            if (window.utils && typeof window.utils.showStatus === 'function') { utils.showStatus(msg, 'warning'); } else { alert(msg); }
            return;
        }

        const rows = appState.processedData;
        
        // Collect ALL headers from ALL records, not just the first one
        const allHeaders = new Set();
        rows.forEach(row => {
            Object.keys(row).forEach(key => allHeaders.add(key));
        });
        const allHeadersArray = Array.from(allHeaders);

        // Build selected categories from Category Manager (if present)
        let selectedCategoryColumns = [];
        try {
            if (typeof selectedCategories !== 'undefined' && selectedCategories) {
                selectedCategoryColumns = Object.entries(selectedCategories)
                    .filter(([_, sel]) => sel)
                    .map(([cat, _]) => cat)
                    .sort();
            }
        } catch (e) { /* ignore */ }

        // Create records including Yes/No for each selected category
        const dataWithCategories = rows.map(record => {
            const newRecord = Object.assign({}, record);
            const recCats = String(record[CONSTANTS.COLUMNS.CATEGORY] || '')
                .split(',').map(c => c.trim()).filter(Boolean);
            selectedCategoryColumns.forEach(category => {
                newRecord[category] = recCats.includes(category) ? 'Yes' : 'No';
            });
            return newRecord;
        });

        // Helper push if present (supports alt names OR constants)
        const pushIfPresent = (arr, nameOrArray) => {
            const candidates = Array.isArray(nameOrArray) ? nameOrArray : [nameOrArray];
            for (const cand of candidates) {
                if (typeof cand === 'string' && allHeadersArray.includes(cand)) { arr.push(cand); return; }
                if (typeof cand === 'object' && cand !== null && 'const' in cand) {
                    const v = CONSTANTS.COLUMNS[cand.const];
                    if (v && allHeadersArray.includes(v)) { arr.push(v); return; }
                }
            }
        };

        // Desired column order (prebuilt), conditionally included if present
        const desiredOrder = [];
        pushIfPresent(desiredOrder, {const:'STUDENT_ID'});                 // Student ID
        pushIfPresent(desiredOrder, 'Name');                               // Name
        pushIfPresent(desiredOrder, 'Student List');                       // Student List
        pushIfPresent(desiredOrder, {const:'ASSIGNED_STAFF'});             // Assigned Staff
        pushIfPresent(desiredOrder, {const:'CATEGORY'});                   // Category
        pushIfPresent(desiredOrder, 'Cumulative GPA');                     // Cumulative GPA
        pushIfPresent(desiredOrder, 'Earned Credits');                     // Earned Credits
        pushIfPresent(desiredOrder, 'Academic Standing');                  // Academic Standing
        pushIfPresent(desiredOrder, 'Predicted Support Level');            // Predicted Support Level
        pushIfPresent(desiredOrder, {const:'ADVISING_OFFICE'});            // Advising Office
        pushIfPresent(desiredOrder, {const:'PROFESSIONAL_ADVISOR'});       // Professional Advisor
        pushIfPresent(desiredOrder, 'Staff ID');                           // Staff ID (advisor file)
        pushIfPresent(desiredOrder, 'Degree');                             // Degree
        pushIfPresent(desiredOrder, {const:'NAV_M'});                      // Navigate Major
        pushIfPresent(desiredOrder, {const:'Major'});                      // Major
        // Student Academic Department (support alternate key names)
        pushIfPresent(desiredOrder, ['Student Academic Department','Student Academic Department_main']);
        pushIfPresent(desiredOrder, [{const:'STUDENT_ACAD_DEPT_SUB'}, 'Student Academic Department_sub', 'Student Academic Department_sub_alt']);      // Student Academic Department_sub
        // Faculty Mentor and related
        pushIfPresent(desiredOrder, 'Faculty Mentor');                      // Faculty Mentor
        pushIfPresent(desiredOrder, 'Mentor ID');                           // Mentor ID
        pushIfPresent(desiredOrder, 'Faculty Academic Department');
        pushIfPresent(desiredOrder, 'Faculty Academic Department_sub');
        pushIfPresent(desiredOrder, 'Faculty Academic Department_home');
        // Peer advisor and related
        pushIfPresent(desiredOrder, 'Peer Advisor');
        pushIfPresent(desiredOrder, 'Peer ID');                             // Peer ID (peer file)
        pushIfPresent(desiredOrder, 'Peer Academic Department');                   // Peer Academic Department
        // Program Director, Librarian
        pushIfPresent(desiredOrder, 'Program Director');
        pushIfPresent(desiredOrder, 'Librarian');

        
        // Safeguard: if 'Student Academic Department_sub' exists but wasn't included, insert it now (before categories)
        const subKeys = ['Student Academic Department_sub', 'Student Academic Department_sub_alt'];
        const presentSub = subKeys.find(k => allHeadersArray.includes(k));
        if (presentSub && !desiredOrder.includes(presentSub)) {
            desiredOrder.push(presentSub);
        }
// Final column order: prebuilt list, then selected categories, then any remaining headers not already included
        const columnOrder = [...desiredOrder];
        selectedCategoryColumns.forEach(col => { if (!columnOrder.includes(col)) columnOrder.push(col); });
        allHeadersArray.forEach(h => { if (!columnOrder.includes(h)) columnOrder.push(h); });

        // Generate CSV
        let csvContent = '';
        if (typeof Papa !== 'undefined' && Papa && Papa.unparse) {
            csvContent = Papa.unparse({ fields: columnOrder, data: dataWithCategories });
        } else {
            const escape = (v) => {
                if (v === null || v === undefined) return '';
                const s = String(v);
                return /[\",\\n]/.test(s) ? '\"' + s.replace(/\"/g, '\"\"') + '\"' : s;
            };
            csvContent = columnOrder.join(',') + '\\n' +
                dataWithCategories.map(r => columnOrder.map(h => escape(r[h])).join(',')).join('\\n');
        }

        // Filename Caseload File_MM.DD.YYYY.csv
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const filename = `Caseload File_${mm}.${dd}.${yyyy}.csv`;

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        if (window.utils && typeof window.utils.showStatus === 'function') {
            utils.showStatus(`CSV exported: ${filename}`, 'success');
        }
    } catch (err) {
        console.error(err);
        if (window.utils && typeof window.utils.showStatus === 'function') {
            utils.showStatus('There was a problem exporting your CSV. See console for details.', 'error');
        } else {
            alert('There was a problem exporting your CSV. See console for details.');
        }
    }
}

// Ensure any legacy bindings call the downloader
window.copyProcessedData = exportProcessedData;

</script>
</body>
</html>